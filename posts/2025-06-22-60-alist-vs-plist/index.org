#+TITLE: ä¸ºä»€ä¹ˆ eq æ¯”è¾ƒä¸‹ alist æŸ¥æ‰¾æ¯” plist å¿«
#+DATE: [2025-06-10 Tue 08:42]--[2025-06-11 Wed 21:04]
#+FILETAGS: elisp
#+DESCRIPTION: æœ¬æ–‡é€šè¿‡ä¸€äº›åˆ†æï¼Œè¯å®äº† eq æ¯”è¾ƒä¸‹çš„ alist æ¯” plist å¿«çš„åŸå› æ˜¯ pointer chasing
#+author: include-yy
#+options: ^:{}

#+FIXME: ä¿®æ­£ L1D latencyï¼Œè®°å¾—åŠ ä¸Š -O3 æ¯”è¾ƒå’Œ LEA ç”¨æ—¶
#+FIXME: è‰ï¼Œå¥½åƒä¸åŠ ä¹Ÿæ²¡ä»€ä¹ˆå½±å“
#+FIXME: ä¹Ÿè®¸éœ€è¦æŠŠ byte-compile å’Œ native-comp æ¯”è¾ƒæå‰

# [[https://www.pixiv.net/artworks/131254021][file:dev/p0.jpg]]

#+begin_comment
https://johnnysswlab.com/the-pros-and-cons-of-explicit-software-prefetching/

https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/data-dependent-prefetcher.html

https://news.ycombinator.com/item?id=33474005
#+end_comment

æœ€è¿‘åœ¨å†™ Org HTML å¯¼å‡ºåç«¯æ—¶ï¼Œæˆ‘ *æ³¨æ„åˆ°* å…ƒç´ æˆ–å¯¹è±¡çš„å¯¼å‡ºå‡½æ•°ä¼šå¤šæ¬¡è°ƒç”¨ =plist-get= æ¥è·å– =info= åˆ—è¡¨ä¸­çš„å±æ€§ï¼Œå¯¹äºä¸å¤§çš„åˆ—è¡¨æ¥è¯´ =plist-get= çš„è°ƒç”¨å¼€é”€å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä½† Org å¯¼å‡ºçš„ INFO ä¸Šä¸‹æ–‡æœ‰ä¸€ä¸¤ç™¾é¡¹ï¼Œé å‰å’Œé åçš„é¡¹çš„æŸ¥æ‰¾æ—¶é—´æœ€å¤šèƒ½å·® 10 å€ã€‚å‡ºäºå¥½å¥‡ï¼Œæˆ‘æµ‹è¯•å¯¹æ¯”äº†ç›¸åŒé”®å€¼å¯¹ä¸‹ä½¿ç”¨ =plist-get= å’Œ =alist-get= çš„æŸ¥æ‰¾ç”¨æ—¶ï¼Œæµ‹è¯•ä»£ç å’Œæµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

:æµ‹è¯•ä»£ç åŠç»“æœ:
#+begin_src elisp
  (defun t-create-plist (n)
    (let ((res))
      (dotimes (x n (reverse res))
        (push x res) (push (% x 2) res))))

  (defun t-create-alist (n)
    (let ((res))
      (dotimes (x n (reverse res))
        (push (cons x (% x 2)) res))))

  (defun test-plist (p n epoch)
    (let ((res))
      (dotimes (x n)
        (let* ((run (benchmark-run epoch (plist-get p x)))
    	     (time (/ (- (car run) (caddr run)) 1.0 epoch)))
    	(push time res)))
      (reverse res)))

  (defun test-alist (a n epoch)
    (let ((res))
      (dotimes (x n)
        (let* ((run (benchmark-run epoch (alist-get x a)))
    	     (time (/ (- (car run) (caddr run)) 1.0 epoch)))
    	(push time res)))
      (reverse res)))

  (let ((native-comp-speed 3))
    (native-compile 'test-alist)
    (native-compile 'test-plist))

  (let ((gc-cons-threshold (expt 1024 3)))
    (benchmark-run 1
      (setq res-p (test-plist (t-create-plist 1000) 1000 1000))))
  (let ((gc-cons-threshold (expt 1024 3)))
    (benchmark-run 1
      (setq res-p1 (test-plist (t-create-plist 10000) 10000 1000))))
  (let ((gc-cons-threshold (expt 1024 3)))
    (benchmark-run 1
      (setq res-a (test-alist (t-create-alist 1000) 1000 1000))))
  (let ((gc-cons-threshold (expt 1024 3)))
    (benchmark-run 1
      (setq res-a1 (test-alist (t-create-alist 10000) 10000 1000))))

  (benchmark-run 1 (setq res-p (test-plist (t-create-plist 64) 64 1000000)))
  (benchmark-run 1 (setq res-a (test-alist (t-create-alist 64) 64 1000000)))
#+end_src

[[./1.png]]
:end:

å—¯... ç²—ç•¥çœ‹ä¸‹æ¥ alist æ¯” plist å¿«å¤§æ¦‚ 30% åˆ° 40%ï¼Œä¸€ä¸ªéå¸¸è‡ªç„¶çš„çŒœæƒ³å°±æ˜¯ plist æ›´é•¿å¯¼è‡´æŸ¥æ‰¾ç›¸åŒé”®æ—¶æ‰§è¡Œçš„ CDR æ“ä½œæ›´å¤šï¼Œæ¯•ç«Ÿåœ¨é”®å€¼å¯¹æ•°é‡ç›¸åŒæ—¶ï¼Œè™½ç„¶å®ƒä»¬ä½¿ç”¨çš„ cons æ•°é‡ç›¸åŒï¼Œä½†æ˜¯ plist æ¯” alist é•¿ä¸€å€ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæ—¶é—´ä¸æ˜¯æ­£å¥½ 1:2 å‘¢ï¼Ÿæœ¬æ–‡ä¼šé€šè¿‡ä¸€äº›åˆ†ææ’é™¤å¹²æ‰°å› ç´ æ¥å¾—å‡ºæœ€ç»ˆç»“è®ºã€‚

ç»“è®ºå°±å…ˆæ”¾åœ¨è¿™é‡Œäº†ï¼š *pointer chasing* ã€‚ä½ å¯èƒ½ä¼šè®¤ä¸ºï¼Œæ—¢ç„¶éƒ½ pointer chasing äº†é‚£é—®é¢˜è‚¯å®šå‡ºåœ¨ç¼“å­˜å‘½ä¸­ä¸Šï¼Œæ€ä¹ˆè¯´å‘¢ï¼Œç¡®å®å’Œç¼“å­˜æœ‰å…³ï¼Œä½†åˆä¸æ˜¯ç¼“å­˜å‘½ä¸­ï¼ˆç¬‘ï¼‰ã€‚

æœ¬æ–‡æ€»ç»“è‡ªæˆ‘åœ¨ Emacs China ä¸Šçš„å¸–å­ [[https://emacs-china.org/t/plist-alist/29589][plist å±…ç„¶æ¯” alist æ…¢]]ï¼Œæœ¬æ–‡ä½¿ç”¨çš„ Emacs ä¸º GNU Emacs 31.0.50 (build 4, x86_64-w64-mingw32) of 2025-06-06ï¼Œcommit ä¸º 2025 å¹´ 6 æœˆ 1 å·åˆ° 6 å·ä¹‹é—´çš„æŸæ¡ commitï¼Œåº”è¯¥å¯¹æˆ‘å†™è¿™ç¯‡æ–‡ç« æ—¶çš„ list è®¿é—®æ€§èƒ½æ²¡æœ‰å¤ªå¤§å½±å“ã€‚

* ä¸€äº›çŒœæƒ³

åœ¨æˆ‘å‘è´´åï¼Œ@gynamics æå‡º plist éå†éœ€è¦åˆ¤æ–­åˆ—è¡¨ä¸­çš„é¡¹æ˜¯å¦ä¸ºé”®ï¼ˆåœ¨æ¥¼ä¸‹è‡ªå·±å¦å®šäº†ï¼‰ï¼Œå¹¶æå‡ºå¦‚æœä»¥ zipped æ–¹å¼éå†ä¼šæé«˜æ•ˆç‡ã€‚æ­¤å¤–ä»–è¿˜æ€€ç–‘ =plist-get= é»˜è®¤ä½¿ç”¨ =equal= åˆ¤æ–­ç›¸ç­‰ã€‚

#+begin_quote
[[https://emacs-china.org/t/plist-alist/29589/3][2025-05-31 07:27 #3]] by gynamics

plist è®¿é—®éœ€è¦è§£æåˆ—è¡¨ä¸­æ¯ä¸€é¡¹ï¼Œçœ‹å®ƒæ˜¯ä¸æ˜¯ keyï¼Œalist åªéœ€è¦è§£æ keyã€‚è¿™å’Œç›¸å…³å‡½æ•°çš„å®ç°æœ‰å…³ï¼Œå¦‚æœ plist åº•å±‚ä½¿ç”¨ zipped çš„æ–¹å¼éå†ï¼Œæ•ˆç‡åº”è¯¥ä¼šé«˜å¾ˆå¤šï¼ˆä½†æ˜¯ä¸å®‰å…¨ï¼Œå› ä¸ºä¸èƒ½æ’é™¤æŸä¸ª key æ²¡æœ‰å€¼çš„æƒ…å†µï¼‰ã€‚alist é•¿åº¦åˆšå¥½æ˜¯ plist ä¸¤å€çš„æƒ…å†µï¼Œæ€§èƒ½å·®ä¸å¤šçš„ã€‚

å¯ä»¥å°è¯•è‡ªå·±å®ç°ä¸€ä¸ªè¿™æ ·çš„ plist-get è¯•è¯•ã€‚

-----------

[[https://emacs-china.org/t/plist-alist/29589/4][2025-05-31 08:07 #4]] by gynamics

æˆ‘å»æŸ¥äº†ä¸‹ï¼Œæœ‰ä¸¤ä¸ªç‰ˆæœ¬çš„å®ç°ï¼š

- =plist-get= ä½¿ç”¨çš„æ˜¯ =equal=, =key= æ˜¯ç¬¦å·çš„æƒ…å†µä¸‹ä½¿ç”¨ =eq=
- =get= ç”¨çš„æ˜¯ =eq= 

è€ƒè™‘åˆ° key çš„å€¼ä¸€èˆ¬æ˜¯ç¬¦å·ï¼Œä½†æ˜¯ä¸ä¸€å®šæ€»æ˜¯ç¬¦å·ï¼Œ +è€ƒè™‘åˆ° equal çš„ç¬¦å·åœ¨ elisp é‡Œå®é™…ä¸ä¸€å®šeq+ ï¼Œæ‰€ä»¥ get å¯èƒ½ä¸åˆä½ çš„é¢„æœŸã€‚

ï¼ˆ =get= æ˜¯ä» =maclisp= ç»§æ‰¿æ¥çš„åŸè¯­ã€‚ =maclisp= é‡Œé¢ä»»ä½•ä¸¤ä¸ª =equal= çš„åŸå­éƒ½ =eq= çš„ï¼‰

æˆ‘ä¹‹å‰æåˆ°çš„ä¸å®‰å…¨çš„ zipped traverse æ²¡æœ‰å‡ºç°ã€‚

----------------------

[[https://emacs-china.org/t/plist-alist/29589/7][2025-05-31 13:44 #7]] by gynamics

> #6 by include-yy \\
> plist éœ€è¦éå†çš„åˆ—è¡¨é•¿åº¦æ›´é•¿ã€‚

è¿™ä¸ªå½±å“åº”è¯¥éå¸¸å°ï¼Œæ€§èƒ½å¼€é”€çš„å¤§å¤´åœ¨å¯¹åˆ—è¡¨æˆå‘˜çš„æ£€æŸ¥ä¸Šã€‚å¦‚æœ plist æ˜¯ä¸¥æ ¼çš„ pair listï¼Œåªæ£€æŸ¥ä¸º key çš„å¥‡æ•°é¡¹ä¸ä¼šæµªè´¹æ—¶é—´ã€‚
#+end_quote

@Kana è·‘äº†ä¸€ä¸‹ perf å‘½ä»¤ï¼Œå‘ç° plist å’Œ alist çš„æŒ‡ä»¤æ•°éƒ½å·®ä¸å¤šï¼Œä½†æ˜¯ =alist-get= çš„ IPC å·®ä¸å¤šæ˜¯ =plist-get= çš„ä¸€å€ï¼Œè€Œä¸”ä¸¤è€…çš„ç¼“å­˜å‘½ä¸­ç‡å’Œåˆ†æ”¯é¢„æµ‹æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚ä»–è¿˜è€ƒè™‘åˆ°äº†å†…å­˜å¯¹å…¶çš„é—®é¢˜ï¼Œ =car= æ˜¯ 16 å­—èŠ‚å¯¹é½è€Œ =cdr= æ˜¯ 8 å­—èŠ‚å¯¹é½ï¼Œè¿™å¯èƒ½å¯¼è‡´è®¿é—®å‰è€…æ›´å¿«ï¼ˆåé¢è‡ªå·±çš„å¸–å­ä¹Ÿç»™å¦äº†ï¼‰ï¼š

#+begin_quote
[[https://emacs-china.org/t/plist-alist/29589/9][2025-05-31 15:44 #9]] by Kana

è·‘äº†ä¸€ä¸‹ perfï¼Œä½†ä»ç„¶çœ‹ä¸å‡ºæ¥ä»€ä¹ˆâ€¦â€¦

:å‘½ä»¤åŠè¾“å‡º:
#+begin_src text
  $ perf stat -B -e cache-references,cache-misses,cycles,instructions,branches,branch-misses emacs -q --batch --script test.el --eval '(test-alist (t-create-alist 2000) 2000 2000)'

   Performance counter stats for 'emacs -q --batch --script test.el --eval (test-alist (t-create-alist 2000) 2000 2000)':

       1,664,859,118      cache-references:u                                                    
          37,560,924      cache-misses:u                   #    2.26% of all cache refs         
      22,989,245,371      cycles:u                                                              
      89,163,920,063      instructions:u                   #    3.88  insn per cycle            
      29,026,961,366      branches:u                                                            
          21,303,743      branch-misses:u                  #    0.07% of all branches           

         5.229262209 seconds time elapsed

         5.180081000 seconds user
         0.023831000 seconds sys


  $ perf stat -B -e cache-references,cache-misses,cycles,instructions,branches,branch-misses emacs -q --batch --script test.el --eval '(test-plist (t-create-plist 2000) 2000 2000)'

   Performance counter stats for 'emacs -q --batch --script test.el --eval (test-plist (t-create-plist 2000) 2000 2000)':

       1,661,666,301      cache-references:u                                                    
          37,152,948      cache-misses:u                   #    2.24% of all cache refs         
      40,751,947,902      cycles:u                                                              
      84,247,031,479      instructions:u                   #    2.07  insn per cycle            
      24,801,242,536      branches:u                                                            
          21,350,234      branch-misses:u                  #    0.09% of all branches           

         9.235591770 seconds time elapsed

         9.183998000 seconds user
         0.022889000 seconds sys
#+end_src
:end:

äºŒè€…çš„æ‰§è¡ŒæŒ‡ä»¤æ•°é‡éƒ½å·®ä¸å¤šï¼Œä½†æ˜¯ IPCï¼ˆinsn per cycleï¼‰ä¸çŸ¥ä¸ºä»€ä¹ˆå·®å¼‚å·¨å¤§ï¼š =alist-get= æ˜¯ 3.8 IPCï¼Œè€Œ =plist-get= æ˜¯ 2.07 IPCï¼Œå‡äº†å°†è¿‘ä¸€åŠã€‚å¸¸è§çš„è§£é‡Šä¸€èˆ¬æ˜¯ç¼“å­˜å‘½ä¸­ç‡æˆ–æ˜¯åˆ†æ”¯é¢„æµ‹æœ‰é—®é¢˜ï¼Œä½†äºŒè€…è¿™ä¸¤é¡¹ä¹Ÿå¤§åŒå°å¼‚â€¦â€¦ä¸çŸ¥é“æœ‰æ²¡æœ‰æ¯”è¾ƒç†Ÿæ‚‰åº•å±‚è°ƒä¼˜çš„äººæ¥åˆ†æä¸€ä¸‹ã€‚

:äºŒè€…ä¸€ä¸ªå¾ªç¯çš„æ“ä½œä¹Ÿå‡ ä¹ä¸€è‡´:

| ç¬¬ 1 åˆ—                 | ç¬¬ 2 åˆ—                |
| plist                   | alist                  |
| (consp list)            | (consp list)           |
| (consp (cdr list))      | (consp (car list))     |
| é cons æ—¶è·³å‡ºå¾ªç¯      | é cons æ—¶ç»§ç»­ä¸‹ä¸ªå¾ªç¯ |
| (eq (car list) key)     | (eq (caar list) key)   |
| (setq list (cddr list)) | (setq list (cdr list)) |

å½“ç„¶ä¸Šé¢ =perf= ç»“æœé‡Œä¹Ÿæ˜¾ç¤ºäºŒè€… =instructions:u= å·®ä¸å¤ªå¤šå°±æ˜¯äº†ã€‚
:end:

æƒ³äº†æƒ³ï¼Œè¿˜æœ‰ä¸€ç§å¯èƒ½æ˜¯å¯¹é½é—®é¢˜ã€‚å¦‚æœ 16-byte å¯¹é½çš„åœ°å€è®¿é—®æ¯” 8-byte å¯¹é½çš„æ›´å¿«çš„è¯ [citation needed]ï¼Œé‚£ä¹ˆ =Lisp_Cons= çš„ =car= åº”è¯¥ä¸€èˆ¬æ˜¯ 16-byte å¯¹é½çš„ï¼Œè€Œç´§è·Ÿåé¢çš„ cdr å°±åªèƒ½æ˜¯ 8-byte å¯¹é½äº†ã€‚ =plist= æ“ä½œ =cdr= æ›´å¤šï¼Œè€Œ =alist= çš„ =car= æ›´å¤šï¼Œè¯´ä¸å®šèƒ½è¯´æ˜é€Ÿåº¦å·®å¼‚ï¼Ÿ

-------------------

[[https://emacs-china.org/t/plist-alist/29589/13][2025-06-01 16:49 #13]] by Kana

> #10 by include-yy \\
> åŒæ ·é”®å€¼å¯¹æ•°é‡ä¸‹ï¼Œplist æ˜¯ alist é•¿åº¦çš„ä¸€å€ï¼Œå¯èƒ½å°±æ˜¯è¿™ä¸ªåŸå› 

ä½†å…¶å® plist å’Œ alist éƒ½éœ€è¦è®¿é—® 2N ä¸ª consï¼Œè€Œä¸”ä¸Šé¢ perf ç»“æœä¹Ÿæ˜¾ç¤ºäºŒè€…æ‰€éœ€çš„æ‰§è¡ŒæŒ‡ä»¤æ•°å·®å¼‚ä¸å¤§ï¼Œå¯èƒ½å’Œ list é•¿åº¦å…³ç³»ä¸å¤§ã€‚ä¸»è¦å›°æƒ‘çš„ç‚¹æ˜¯äºŒè€…æŒ‡ä»¤çš„æ‰§è¡Œæ•ˆç‡å·®å¼‚å¤ªå¤§äº†ã€‚

> #11 by gynamics \\
> æˆ‘ç”¨ =-O2 -g3= ç¼–äº†ä¸€ä¸ª emacs è·‘æµ‹è¯•ï¼Œä¸¤è¾¹è®¿é—®çš„æ•°æ®éƒ½ä¸æ˜¯å¯¹é½çš„ã€‚ä½†æ˜¯ cdr è¸©åˆ°çš„çƒ­ç‚¹ä¼¼ä¹æ›´å¤šä¸€äº›ã€‚

çš„ç¡®ä¸æ˜¯å¯¹é½çš„é—®é¢˜ï¼šè¯•ç”¨äº†ä¸‹ aiderï¼Œç®€å•ç”¨ C å®ç°äº† cons å’Œ alist-get åŠ plist-getï¼Œä»ç„¶æœ‰æ˜¾è‘—çš„é€Ÿåº¦å·®å¼‚ï¼Œå³ä½¿è°ƒè½¬ car å’Œ cdr çš„é¡ºåºè®© cdr æ”¾åœ¨å‰é¢è¿›è¡Œ 16byte å¯¹é½ã€‚

https://github.com/gudzpoz/alist-plist-benchmark

æŠŠ =car= å’Œ =cdr= äº’æ¢åï¼ŒäºŒè€…çš„æ±‡ç¼–å¯ä»¥è¯´æ˜¯æŒ‡ä»¤çº§çš„ä¸€è‡´ï¼š

#+attr_html: :class data
| =alist= å¾ªç¯          | ~plist~ å¾ªç¯          | ä¸€è‡´ï¼Ÿ |
| =mov (%rdi), %rax=    | =mov (%rdi), %rax=    | ğŸŸ©    |
| =cmp %rsi, (%rax)=    | =cmp %rsi, %x8(%rdi)= | âŒ    |
| =je :break_loop=      | =je :break_loop=      | ğŸŸ©    |
| =mov 0x8(%rdi), %rdi= | =mov (%rax), %rdi=    | âŒ    |
| =test %rdi, %rdi=     | =test %rdi, %rdi=     | ğŸŸ©    |
| =jne :loop_start=     | =jne :loop_start=     | ğŸŸ©    |

*æˆ‘æ˜¯æƒ³ä¸æ˜ç™½äº†ï¼Œæˆ–è®¸å’ŒæŒ‡ä»¤é—´çš„æ•°æ®ä¾èµ–å¯¼è‡´æ— æ³•æµæ°´çº¿å¹¶è¡Œæœ‰å…³ï¼Ÿ*
#+end_quote

@acoretï¼ˆ[[https://emacs-china.org/t/plist-alist/29589/14][2025-06-01 17:58 #14]]ï¼‰è®¤ä¸º plistï¼ˆä¹Ÿå¯èƒ½æ˜¯ alistï¼‰æ›´ç¬¦åˆç¼“å­˜æœºåˆ¶ï¼Œå¹¶å»ºè®®ä½¿ç”¨å…¶ä»– Scheme å¤ç°ä¸€ä¸‹ plist å’Œ alistã€‚

@cireuï¼ˆ[[https://emacs-china.org/t/plist-alist/29589/16][2025-06-02 15:42 #16]]ï¼‰è®¤ä¸º plist æ›´é•¿ï¼Œæ‰€ä»¥éœ€è¦çš„ pointer chasing æ›´å¤šã€‚

** =plist= éœ€è¦è§£ææ¯ä¸€é¡¹çš„ =car=

å½“ç„¶ï¼Œè¿™ä¸€çŒœæƒ³å·²ç»ç”± @gynamics å¦å®šäº†ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥å€Ÿæ­¤æœºä¼šå…ˆç®€å•äº†è§£ä¸€ä¸‹ plist å’Œ alist çš„ç»“æ„ï¼š

- =plist=: =(k1 v1 k2 v2 k3 v3 ...)=
- =alist=: =((k1 . v1) (k2 . v2) (k3 . v3) ...)=

åœ¨æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œ =plist-get= æ¯è½®å¾ªç¯ä¼šå–ä¸¤æ¬¡ CDR åˆ°è¾¾ä¸‹ä¸€ä¸ª KV é”®å€¼å¯¹ï¼Œåˆ¤æ–­å½“å‰è¡¨å¤´çš„ CAR æ˜¯å¦ä¸æŸ¥æ‰¾é”®ç›¸åŒï¼Œè‹¥ç›¸åŒåˆ™è¿”å›å½“å‰è¡¨å¤´çš„ CADRï¼Œå¦åˆ™ç»§ç»­å¾ªç¯ï¼› =alist-get= æ¯è½®å¾ªç¯ä¼šå–ä¸€æ¬¡ CDR åˆ°è¾¾ä¸‹ä¸€ä¸ª KV CONSï¼Œåˆ¤æ–­è¡¨å¤´çš„ CONS çš„ CAR æ˜¯å¦ä¸æŸ¥æ‰¾é”®ç›¸åŒï¼Œè‹¥ç›¸åŒåˆ™è¿”å› KV CONS çš„ CDRï¼Œå¦åˆ™ç»§ç»­å¾ªç¯ã€‚å®ƒä»¬çš„æŸ¥æ‰¾è¿‡ç¨‹å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä¼ªä»£ç è¡¨ç¤ºï¼š

#+begin_src elisp
  (defun pesudo-pget (plist key)
    (while (and plist (not (eq (car plist) key)))
      (setq plist (cdr (cdr plist))))
    (and plist (car (cdr plist))))

  (defun pesudo-aget (key alist)
    (while (and alist (not (eq (car (car alist)) key)))
      (setq alist (cdr alist)))
    (and alist (cdr (car alist))))
#+end_src

åœ¨ä¸Šé¢çš„å¾ªç¯ä½“ä¸­ï¼Œæ¯æ¬¡å¾ªç¯ =pesudo-pget= ä¼šå–ä¸¤æ¬¡ CDR å’Œä¸€æ¬¡ CARï¼› =pesudo-aget= ä¼šå–ä¸¤æ¬¡ CAR å’Œä¸€æ¬¡ CDRã€‚è€ƒè™‘åˆ° CONS çš„ CAR å’Œ CDR æ˜¯å¯¹é½ä¸”ç´§é‚»çš„ï¼ŒCAR å’Œ CDR çš„è°ƒç”¨å¼€é”€åº”è¯¥å‡ ä¹ä¸€è‡´ï¼Œä»…å‡­ä¸Šé¢çš„ Lisp ä»£ç ä¸è¶³ä»¥è§£é‡Šä¸ºä»€ä¹ˆ =alist-get= æ¯” =plist-get= æ›´å¿«ã€‚

è¿™é‡Œæˆ‘ä»¬å¯ä»¥é¡ºä¾¿äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ zipped éå†ï¼ˆzipped iterationï¼‰ï¼Œå®ƒæŒ‡çš„æ˜¯åŒæ—¶éå†ä¸¤ä¸ªæˆ–å¤šä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œå¹¶åœ¨æ¯æ¬¡è¿­ä»£ä¸­ä»æ¯ä¸ªå¯¹è±¡ä¸­è·å–å¯¹åº”ä½ç½®çš„å…ƒç´ ã€‚å½“ç„¶å¯¹ plist æ¥è¯´æˆ‘ä»¬åªæœ‰ä¸€æ¡åˆ—è¡¨ï¼Œå¯ä»¥è€ƒè™‘æŠŠå®ƒæŒ‰ç…§å¥‡å¶æ‹†æˆä¸¤æ¡ç„¶åä½¿ç”¨ =cl-mapc= æ¥éå†ã€‚

æœ€åæˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹ =map.el= è¿™ä¸ªå†…ç½®çš„ Elisp åº“ï¼Œå®ƒä¸º Elisp çš„å…³è”æ•°æ®ç»“æ„ï¼ˆplist, alist å’Œ hashtableï¼‰æä¾›äº†å¤šæ€å‡½æ•°ï¼Œæ¯”å¦‚ =map-elt= å¯ä»¥ç”¨æ¥æŸ¥æ‰¾è¿™ä¸‰ç§æ•°æ®ç±»å‹çš„é”®å¯¹åº”å€¼ï¼š

#+begin_src elisp
  (map-elt '(:a 1 :b 2) :b)                  ;;=> 2
  (map-elt '((a . 1) (b . 2)) 'b)            ;;=> 2
  (map-elt #s(hash-table data (a 1 b 2)) 'b) ;;=> 2
#+end_src

** =plist-get= ä½¿ç”¨äº† =equal=

@gynamics æåˆ° =plist-get= ä½¿ç”¨çš„æ˜¯ =equal=â€‹ï¼Œ +ä½†æ˜¯ =equal= çš„ç¬¦å·åœ¨ elisp é‡Œå®é™…ä¸ä¸€å®š ~eq~+ ï¼ˆè¿™ä¸€æ¡è¢«ä»–è‡ªå·±å¦å®šäº†ï¼‰ã€‚è€ƒè™‘åˆ° =equal= ä¼šè¿›è¡Œâ€œæ·±åº¦æ¯”è¾ƒâ€ï¼Œè¿™å¯èƒ½æˆä¸º =plist-get= å’Œ =alist-get= çš„æ€§èƒ½å·®è·çš„ä¸»è¦åŸå› ã€‚ä¸è¿‡é€šè¿‡ =plist-get= å’Œ =alist-get= çš„ docstring æ¥çœ‹ï¼Œå®ƒä»¬é»˜è®¤ä½¿ç”¨çš„æ˜¯ =eq=â€‹ï¼š

#+begin_src text
plist-get is a primitive-function in â€˜C source codeâ€™.

(plist-get PLIST PROP &optional PREDICATE)

Declared type: (function (list t &optional t) t)

Extract a value from a property list.
PLIST is a property list, which is a list of the form
(PROP1 VALUE1 PROP2 VALUE2...).

This function returns the value corresponding to the given PROP, or
nil if PROP is not one of the properties on the list.  The comparison
with PROP is done using PREDICATE, which defaults to â€˜eqâ€™.
#+end_src

#+begin_src text
alist-get is a native-comp-function in â€˜subr.elâ€™.

(alist-get KEY ALIST &optional DEFAULT REMOVE TESTFN)

Inferred type: (function (t t &optional t t t) t)

Find the first element of ALIST whose â€˜carâ€™ equals KEY and return its â€˜cdrâ€™.
If KEY is not found in ALIST, return DEFAULT.
Equality with KEY is tested by TESTFN, defaulting to â€˜eqâ€™.
#+end_src

** æ€§èƒ½å¼€é”€ä¸»è¦åœ¨é”®æ¯”è¾ƒä¸Š

å¦‚æœé”®æ¯”è¾ƒæ˜¯æœ€ä¸»è¦çš„æ€§èƒ½å¼€é”€ï¼Œé‚£ä¹ˆ plist/alist çš„æŸ¥æ‰¾ç”¨æ—¶å°±ä¸»è¦ä¸å¾…æŸ¥é”®å€¼å¯¹åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®æœ‰å…³ï¼Œè€Œä¸ plist/alist é•¿åº¦å·®è·æ— å…³ï¼ˆè‹¥ plist å’Œ alist å…·æœ‰å®Œå…¨ç›¸åŒçš„é”®å€¼å¯¹ï¼Œé‚£ä¹ˆå‰è€…æ˜¯åè€…é•¿åº¦çš„ä¸€å€ï¼‰ã€‚â€‹=plist-get= å’Œ =alist-get= å†…éƒ¨ä½¿ç”¨çš„ =plist_get= å’Œ =assq= å­ä¾‹ç¨‹ï¼ˆsubrï¼‰éƒ½ç›´æ¥ä½¿ç”¨äº† =EQ= è¿›è¡Œæ¯”è¾ƒï¼Œåœ¨ 64 ä½ç³»ç»Ÿä¸Šè¿™ *å‡ ä¹* å°±æ˜¯ç®€å•çš„å€¼æ¯”è¾ƒï¼š

#+begin_src c
#define lisp_h_XLI(o) ((EMACS_INT) (o))
#define lisp_h_BASE_EQ(x, y) (XLI (x) == XLI (y))
#define BASE_EQ(x, y) lisp_h_BASE_EQ (x, y)

/* Return true if X and Y are the same object.  */
INLINE bool
(BASE_EQ) (Lisp_Object x, Lisp_Object y)
{
  return lisp_h_BASE_EQ (x, y);
}

/* Return true if X and Y are the same object, reckoning a symbol with
   position as being the same as the bare symbol.  */
INLINE bool
EQ (Lisp_Object x, Lisp_Object y)
{
  return BASE_EQ ((__builtin_expect (symbols_with_pos_enabled, false)
		   && SYMBOL_WITH_POS_P (x) ? XSYMBOL_WITH_POS_SYM (x) : x),
		  (__builtin_expect (symbols_with_pos_enabled, false)
		   && SYMBOL_WITH_POS_P (y) ? XSYMBOL_WITH_POS_SYM (y) : y));
}
#+end_src

ä¸Šé¢çš„ =EQ= è¿˜å¸¦äº†ä¸€äº›å¥‡æ€ªçš„ =SYMBOL_WITH_POS= ï¼Œä¸è¿‡è¿™æ˜¯ç¼–è¯‘æ—¶æ‰ç”¨åˆ°çš„ä¿¡æ¯ï¼š[[https://github.com/emacs-mirror/emacs/commit/b0ba0d42b0fdf70a20cd7a070128db8abe4a0826][b0ba0d4 * src/lisp.h (EQ): Improve generated code.]]

#+begin_quote
Outside compilation 'symbols_with_pos_enabled' is always false, so ask
the compiler to organize the most likely execution path in a sequential
fashion in order to favor run-time performance.
#+end_quote

åœ¨å­ä¾‹ç¨‹ =plist_get= å’Œ =assq= ä¸­å¯ä»¥çœ‹åˆ°æ¯”è¾ƒæ–¹æ³•å°±æ˜¯ =EQ= ï¼Œè€Œä¸”ä¸¤è€…çš„æœ€å¤§åŒºåˆ«å¯èƒ½æ˜¯ =plist_get= ä½¿ç”¨äº† =FOR_EACH_TAIL_SAFE= è€Œ =assq= ä½¿ç”¨äº† =FOR_EACH_TAIL= ï¼Œä»¥åŠæ¯è½®å¾ªç¯ =plist_get= å®é™…ä¸Šå–äº†ä¸¤æ¬¡ =XCDR= ï¼š

:plist_get-and-assq:
#+begin_src c
  /* Faster version of Fplist_get that works with EQ only.  */
  Lisp_Object
  plist_get (Lisp_Object plist, Lisp_Object prop)
  {
    Lisp_Object tail = plist;
    FOR_EACH_TAIL_SAFE (tail)
      {
        if (! CONSP (XCDR (tail)))
  	break;
        if (EQ (XCAR (tail), prop))
  	return XCAR (XCDR (tail));
        tail = XCDR (tail);
      }
    return Qnil;
  }
#+end_src

#+begin_src c
  DEFUN ("assq", Fassq, Sassq, 2, 2, 0,
         doc: /* Return non-nil if KEY is `eq' to the car of an element of ALIST.
  The value is actually the first element of ALIST whose car is KEY.
  Elements of ALIST that are not conses are ignored.  */)
    (Lisp_Object key, Lisp_Object alist)
  {
    Lisp_Object tail = alist;
    FOR_EACH_TAIL (tail)
      if (CONSP (XCAR (tail)) && EQ (XCAR (XCAR (tail)), key))
        return XCAR (tail);
    CHECK_LIST_END (tail, alist);
    return Qnil;
  }
#+end_src
:end:

å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹å½“æ€§èƒ½å¼€é”€çœŸæ­£åœ¨é”®æ¯”è¾ƒä¸Šæ˜¯ä¸ªä»€ä¹ˆæƒ…å†µï¼Œä¸‹é¢çš„ä»£ç ä½¿ç”¨å­—ç¬¦ä¸²è€Œä¸æ˜¯ç¬¦å·ä½œä¸ºé”®ï¼Œä½¿ç”¨ =string== è€Œä¸æ˜¯é»˜è®¤çš„ =eq= æ¥æ¯”è¾ƒã€‚ä¸‹å›¾è¯´æ˜è¿™ç§æƒ…å†µä¸‹ alist/plist æŸ¥æ‰¾æ€§èƒ½æ²¡æœ‰æ˜æ˜¾å·®è·ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½ç”¨åœ¨ =string= æ¯”è¾ƒä¸Šäº†ï¼š

:test:
#+begin_src elisp
  (setq pl
        (let ((res))
  	(dotimes (x 64)
  	  (push (format "%03d" x) res)
  	  (push t res))
  	(nreverse res)))
  (setq al
        (let ((res))
  	(dotimes (x 64)
  	  (push (cons (format "%03d" x) t) res))
  	(nreverse res)))

  (defun test-pl (ls epoch)
    (let ((keys (map-keys ls)) res)
      (dolist (k keys)
        (let* ((run (benchmark-run epoch (plist-get ls k #'string=)))
  	     (time (/ (car run) 1.0 epoch)))
  	(push time res)))
      (nreverse res)))

  (defun test-al (ls epoch)
    (let ((keys (map-keys ls)) res)
      (dolist (k keys)
        (let* ((run (benchmark-run epoch (alist-get k ls nil nil #'string=)))
  	     (time (/ (car run) 1.0 epoch)))
  	(push time res)))
      (nreverse res)))

  (let ((native-comp-speed 3))
    (native-compile 'test-pl)
    (native-compile 'test-al))

  (setq res-p (test-pl pl 1000000))
  (setq res-a (test-al al 1000000))
#+end_src
:end:

[[./2.png]]

** å†…å­˜å¯¹é½å¯¼è‡´ CAR æ¯” CDR å¿«

è¿™ä¸€çŒœæƒ³ç”± @Kana æå‡ºå’Œå¦å®šï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥å€Ÿæ­¤æœºä¼šçœ‹çœ‹ Lisp_Cons çš„æ•°æ®ç»“æ„ï¼š

#+begin_src c
  struct Lisp_Cons
  {
    union
    {
      struct
      {
        /* Car of this cons cell.  */
        Lisp_Object car;

        union
        {
  	/* Cdr of this cons cell.  */
  	Lisp_Object cdr;

  	/* Used to chain conses on a free list.  */
  	struct Lisp_Cons *chain;
        } u;
      } s;
      GCALIGNED_UNION_MEMBER
    } u;
  };
#+end_src

ç»“æ„ä¸­åŒ…å«ä¸¤ä¸ª =Lisp_Object= æˆå‘˜ =car= å’Œ =cdr= ï¼Œå…¶ä¸­ =cdr= å’Œä¸€ä¸ªå«åš =chain= çš„æˆå‘˜åœ¨åŒä¸€è”åˆä½“ä¸­ï¼Œ =chain= è¢«ç”¨æ¥ç®¡ç†ç©ºé—² consã€‚åœ¨ 64 ä½ç³»ç»Ÿä¸­ =Lisp_Cons= å ç”¨ 16 ä¸ªå­—èŠ‚ï¼Œæ˜¯ 16 å­—èŠ‚å¯¹é½çš„ã€‚è€ƒè™‘åˆ°ç¼“å­˜è¡Œï¼ˆCache lineï¼‰ä¸€èˆ¬æ˜¯ 64 å­—èŠ‚ï¼Œå•ä¸ª Lisp_Cons ä¸å¤ªå¯èƒ½å‡ºç°è·¨ç¼“å­˜è¡Œçš„æƒ…å†µã€‚

å½“ç„¶ @Kana æƒ³è¯´çš„æ˜¯ 16 å­—èŠ‚å¯¹é½çš„ =CAR= å¯èƒ½æ¯” 8 å­—èŠ‚å¯¹é½çš„ =CDR= è®¿é—®æ›´å¿«ï¼Œå› ä¸º =plist_get= è®¿é—®äº†ä¸¤æ¬¡ =CDR= å’Œä¸€æ¬¡ =CAR= ï¼Œè€Œ =assq= è®¿é—®äº†ä¸¤æ¬¡ =CAR= å’Œä¸€æ¬¡ =CDR= ï¼Œè¿™ä¹Ÿè®¸èƒ½è§£é‡Šä¸ºä»€ä¹ˆ =assq= æ¯” =plist_get= å¿«ã€‚ä½†ä»–é€šè¿‡äº¤æ¢ =CAR= å’Œ =CDR= åœ¨ =Lisp_Cons= ä¸­çš„ä½ç½®çš„[[https://github.com/gudzpoz/alist-plist-benchmark][æµ‹è¯•]]å¦å®šäº†è¿™ä¸€ç‚¹ï¼š

** ç¼“å­˜æœªå‘½ä¸­

æ—¢ç„¶ =CAR=, =CDR= è°ƒç”¨å¼€é”€åŸºæœ¬ä¸Šæ²¡æœ‰å·®è·ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰å¯èƒ½æ˜¯å› ä¸º CONS åœ¨å†…å­˜ä¸­å¤ªè¿‡åˆ†æ•£å¯¼è‡´é¢‘ç¹çš„ cache missï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰å‘¢ï¼Ÿåœ¨å†…å­˜ *ç¦»æ•£* è¿™ä¸€ç‚¹ä¸Š plist å’Œ alist åŸºæœ¬ä¸Šæ˜¯äº”åæ­¥ç¬‘ç™¾æ­¥çš„åŒºåˆ«ï¼Œè‡³äºå†…å­˜æ˜¯å¦ *é›†ä¸­* ä¸»è¦å–å†³äº Elisp çš„åˆ†é…æ–¹æ³•ã€‚

Elisp ä¸­ CONS çš„åˆ†é…ç®—æ³•ä½äº alloc.c ä¸­ï¼Œç®€å•æ¥è¯´ CONS ä½äºä¸åŒçš„ CONS block ä¸­ï¼Œæ¯ä¸ª CONS block æ˜¯ 32KB å­—èŠ‚å¯¹é½ï¼Œç†è®ºè®¡ç®—æœ€å¤šå¯ä»¥å®¹çº³ 2048 ä¸ª 16 å­—èŠ‚ CONSï¼Œä½†æ˜¯ CONS block è¿˜éœ€è¦ä¿å­˜ GC bitmark ä¿¡æ¯ï¼Œæœ€å¤šå…è®¸ 2030 ä¸ª CONSã€‚Elisp ä½¿ç”¨ä¸€ä¸ªå«åš =cons_free_list= çš„é“¾è¡¨ç®¡ç†ç©ºé—² consï¼Œè¿™ä¹Ÿæ˜¯ =Lisp_Cons= ä¸­ =chain= æˆå‘˜çš„ä½œç”¨ï¼Œå®ƒæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„ CONS ç›´åˆ°ç©ºæŒ‡é’ˆã€‚

å½“ =cons_free_list= ä¸ä¸ºç©ºé“¾è¡¨æ—¶ï¼Œæ–°åˆ†é…çš„ CONS ä»é“¾è¡¨ä¸­è·å–ï¼›å½“ =cons_free_list= ä¸ºç©ºæ—¶ï¼Œæ–°åˆ†é…çš„ CONS ä» CONS block ä¸­è·å–ï¼Œè‹¥å½“å‰ CONS block è€—å°½åˆ™åˆ†é…æ–°çš„ CONS blockã€‚æˆ‘åœ¨å¤§æ¦‚ä¸‰å¹´å‰ç”»è¿‡ symbol å†…å­˜ç®¡ç†çš„ç¤ºæ„å›¾ï¼Œç°åœ¨ä¸€çœ‹å’Œ CONS æŒºç›¸ä¼¼çš„ï¼Œæ”¹æ”¹å°±å¯ä»¥æ‹¿è¿‡æ¥ç”¨äº†ï¼š

[[./3.png]]

å½“ =cons_free_list= ä¸­å­˜åœ¨å¤§é‡ç¢ç‰‡ CONSï¼Œä¸”å„ CONS åˆ†å¸ƒäºä¸åŒçš„ CONS block ä¸­æ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºçš„ plist/alist åœ¨æŸ¥æ‰¾æ—¶ä¼šå—åˆ°å¾ˆå¤§çš„ cache miss å½±å“ã€‚è™½ç„¶ Elisp çš„åƒåœ¾å›æ”¶å¾ˆ lowï¼Œç”šè‡³æ²¡æœ‰ç¢ç‰‡æ•´ç†ï¼Œæˆ‘åœ¨å®é™…æµ‹è¯•æ—¶å‘ç°æ—¥å¸¸ä½¿ç”¨ä¸­ =cons_free_list= ä¸­ CONS çš„ç¢ç‰‡åŒ–å¹¶æ²¡æœ‰æˆ‘æƒ³è±¡çš„é‚£ä¹ˆä¸¥é‡ã€‚æ¢è¨€ä¹‹ï¼Œç¼“å­˜æœªå‘½ä¸­å¹¶ä¸æ˜¯å½±å“ plist/alist æ€§èƒ½å·®è·çš„ä¸»è¦å› ç´ ã€‚

å¦‚æœæˆ‘ä»¬æƒ³è¦å®Œå…¨é¿å… CONS ç¢ç‰‡åŒ–çš„å½±å“å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸€æ•´ä¸ª CONS block ä¸­çš„ CONS æ¥æ„å»º alist/plist å¹¶æµ‹è¯•ï¼Œè¿™ *ä»…ä»…* åœ¨ Elisp å±‚é¢éš¾ä»¥åšåˆ°ï¼Œä½†é€šè¿‡ç¼–å†™ Emacs C æºä»£ç å¯ä»¥è§£å†³ã€‚ä¸‹é¢æˆ‘ä¼šä»‹ç»é¿å…ç¼“å­˜æœªå‘½ä¸­çš„æ–¹æ³•ï¼Œè¿™éœ€è¦å¯¹ =Fcons= çš„å·¥ä½œåŸç†æœ‰äº›ç®€å•äº†è§£ã€‚

** pointer chasing

#+begin_quote
[[https://emacs-china.org/t/plist-alist/29589/16][2025-06-02 15:42 #16]] by cireu

çŒœæµ‹ä¸€ä¸‹ï¼šplist æ›´é•¿ï¼Œæ‰€ä»¥éœ€è¦çš„ pointer chasing æ›´å¤šï¼Œæ¯”å¦‚æŠŠ list æ‹†æˆ pair çš„è¡¨ç¤ºæ³•

#+begin_src elisp
(:a 1 :b 2 :c 3) => (:a . (1 . (:b . (2 . (:c . (3 . nil))))))

((a . 1) (b . 2) (c . 3)) => ((a . 1) . ((b . 2) . ((c . 3) . nil)))
#+end_src

alist è®¿é—®åˆ°ä¸€ä¸ª key-value pair, ç›´æ¥å– pair çš„ cdr å°±å¯ä»¥è®¿é—® value, plist è®¿é—®åˆ° key è¿˜è¦å– cdr çš„ car æ‰èƒ½è®¿é—®åˆ° value.
#+end_quote

æœ¬æ–‡ä¹Ÿä¸æ˜¯ä»€ä¹ˆå‰§æƒ…è·Œå®•èµ·ä¼çš„å°è¯´ï¼Œæ‰€ä»¥å°±åƒæˆ‘åœ¨æœ¬æ–‡å¼€å¤´é‚£æ ·æˆ‘å°±ç›´è¯´äº†ï¼Œå¯¼è‡´ alist/plist æ€§èƒ½å·®å¼‚çš„ä¸»è¦åŸå› å°±æ˜¯ pointer chasingï¼Œåªä¸è¿‡ @cireu çš„ååŠæ®µå¹¶ä¸æ­£ç¡®ã€‚

pointer æ˜¯æŒ‡é’ˆï¼Œchase(chasing) æ˜¯è¿½é€ï¼Œpointer chasing åˆèµ·æ¥å¯ä»¥ç¿»è¯‘æˆâ€‹*æŒ‡é’ˆè¿½é€*â€‹ã€‚æ‰€è°“æŒ‡é’ˆè¿½é€æŒ‡çš„æ˜¯ä¸€ç§å†…å­˜è®¿é—®æ¨¡å¼ï¼šè¿ç»­è®¿é—®å†…å­˜ä¸”æ¯æ¬¡è®¿é—®çš„åœ°å€éƒ½ç”±å‰ä¸€æ¬¡è®¿é—®è·å¾—çš„æ•°æ®å†³å®šã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯é€šè¿‡ä¸€ä¸ªæŒ‡é’ˆæ‰¾åˆ°ä¸€ä¸ªæ•°æ®ï¼Œç„¶åè¿™ä¸ªæ•°æ®åˆåŒ…å«äº†ä¸‹ä¸€ä¸ªæŒ‡é’ˆï¼Œå†é€šè¿‡è¿™ä¸ªæ–°æŒ‡é’ˆæ‰¾åˆ°ä¸‹ä¸€ä¸ªæ•°æ®ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå½¢æˆä¸€ä¸ªä¸²è”çš„ã€ä¾èµ–æ€§çš„åŠ è½½é“¾ã€‚

pointer chasing è¿™ä¸€æ¨¡å¼çš„å…¸å‹æ¡ˆä¾‹å°±æ˜¯å¯¹å•é“¾è¡¨çš„éå†ï¼Œè¿™ä¹Ÿæ­£æ˜¯æœ¬æ–‡è®¨è®ºçš„å¯¹ alist/plist çš„æŸ¥æ‰¾ã€‚é‚£ä¹ˆï¼Œpointer chasing æœ‰ä»€ä¹ˆç‰¹ç‚¹å‘¢ï¼Ÿ

1. ä¸²è¡Œä¾èµ–ï¼ˆSerial Dependenceï¼‰ã€‚åç»­çš„å†…å­˜è®¿é—®å¿…é¡»ç­‰åˆ°å‰ä¸€æ¬¡è®¿é—®çš„ç»“æœæ‰èƒ½ç¡®å®šä¸‹ä¸€ä¸ªè¦è®¿é—®çš„åœ°å€ã€‚è¿™æ„å‘³ç€å†…å­˜è®¿é—®å¾ˆéš¾å¹¶è¡ŒåŒ–ã€‚
2. ä¸è§„åˆ™çš„å†…å­˜è®¿é—®ã€‚é“¾è¡¨ç­‰ç»“æ„çš„åœ°å€é€šå¸¸æ˜¯è·³è·ƒå’Œä¸è¿ç»­çš„ï¼Œå¦‚æœé“¾è¡¨å•å…ƒçš„å±€éƒ¨æ€§ä¸å¥½ï¼ˆæ¯”å¦‚ CONS è·¨ CONS block é“¾æ¥ï¼‰ï¼Œä¼šå¯¼è‡´è¾ƒä½çš„ç¼“å­˜å‘½ä¸­ç‡ã€‚

æ ¹æ®è¿™ä¸¤ä¸ªç‰¹ç‚¹ï¼Œpointer chasing ä¼šå¯¼è‡´ç¨‹åº *éš¾ä»¥å¹¶è¡Œ* å’Œ *å¯¹å»¶è¿Ÿæ•æ„Ÿ* ã€‚å¯¹äº alist/plist çš„æŸ¥æ‰¾ï¼Œå¦‚æœé”®æ¯”è¾ƒå¼€é”€è¿œå°äºåˆ—è¡¨ CDR æ“ä½œå¼€é”€ï¼Œé‚£ä¹ˆç¨‹åºçš„æ€§èƒ½å°†å–å†³äºå†…å­˜è®¿é—®å»¶è¿Ÿã€‚

ä¸‹é¢ï¼Œè®©æˆ‘ä»¬è¯•ç€æ’é™¤ç¼“å­˜å‘½ä¸­å¯¹ç¨‹åºçš„å½±å“ã€‚

* æ’é™¤ cache miss çš„å½±å“

æ—¢ç„¶é“¾è¡¨ç»“æ„æ•°æ®å®¹æ˜“ç¼“å­˜æœªå‘½ä¸­ï¼Œé‚£æˆ‘æŠŠæ‰€æœ‰çš„é“¾è¡¨èŠ‚ç‚¹æ”¾åˆ°ä¸€ä¸ªå°äº CPU L1-cache çš„å†…å­˜å—é‡Œé¢ä¸å°±è¡Œäº†ï¼Ÿè¿™åœ¨ Rust é‡Œé¢ä¹Ÿå« arenaï¼ˆç«æŠ€åœºï¼‰ï¼Œæœ‰ä¸€å † crate å®ç°äº† arenaï¼š

#+caption: https://donsz.nl/blog/arenas/
[[./4.png]]

å¯¹äºç°åœ¨ï¼ˆ2025ï¼‰çš„ä¸€èˆ¬çš„æ¡Œé¢ CPU æ¥è¯´ï¼ŒL1-cache ä¸€èˆ¬åœ¨ 32KB åˆ° 64KB ä¹‹é—´ï¼ŒL1 å’Œ L2 ä¸€èˆ¬æ˜¯å•ä¸ªæ ¸å¿ƒç‹¬å ï¼Œè€Œ L3 æ˜¯æ‰€æœ‰æ ¸å¿ƒå…±äº«ã€‚ä»¥æˆ‘ä½¿ç”¨è¿‡çš„å‡ æ¬¾æœºå™¨ä¸­çš„ CPU æ¥è¯´ï¼Œå®ƒä»¬çš„ cache å¤§å°å¦‚ä¸‹æ‰€ç¤ºï¼š

#+attr_html: :class data
| CPU å‹å·    |           æ ¸å¿ƒæ•° | L1(æ€»å…±/å•æ ¸) | L2(æ€»å…±/å•æ ¸)             | L3   |
| [[https://www.amd.com/en/support/downloads/drivers.html/processors/ryzen/ryzen-6000-series/amd-ryzen-9-6900hx.html][6900HX]]      |                8 | 512KB / 64KB  | 4MB / 512KB               | 16MB |
| [[https://www.amd.com/en/products/processors/laptop/ryzen/7000-series/amd-ryzen-5-7640hs.html][7640HS]]      |                6 | 384KB / 64KB  | 6MB / 1MB                 | 16MB |
| [[https://www.intel.com/content/www/us/en/products/sku/196656/intel-core-i511300h-processor-8m-cache-up-to-4-40-ghz-with-ipu/specifications.html][i5-11300H]]   |                4 | 192KB / 48KB  | 5MB / 1280KB              | 8MB  |
| [[https://www.intel.cn/content/www/cn/zh/products/sku/241751/intel-core-ultra-7-processor-255h-24m-cache-up-to-5-10-ghz/specifications.html][ultra7-255H]] | 6(P)+8(E)+2(LPE) | 1MB / 64KB    | (P)18MB/3MB, (E/LPE)2MB/X | 24MB |

å•ä¸ª CONS block çš„å¤§å°æ˜¯ 32KBï¼Œæ˜¯èƒ½å¤Ÿå…¨éƒ¨æ”¾å…¥ L1-cache çš„ã€‚ç°åœ¨çš„é—®é¢˜å°±æ˜¯å¦‚ä½•ä¿è¯æ‰€æœ‰ç”¨åˆ°çš„ CONS éƒ½åœ¨ CONS block ä¸Šã€‚ä¸‹é¢æ˜¯ =Fcons= çš„å®ç°ï¼š

#+begin_src c
  DEFUN ("cons", Fcons, Scons, 2, 2, 0,
         doc: /* Create a new cons, give it CAR and CDR as components, and return it.  */)
    (Lisp_Object car, Lisp_Object cdr)
  {
    register Lisp_Object val;

    if (cons_free_list)
      {
        ASAN_UNPOISON_CONS (cons_free_list);
        XSETCONS (val, cons_free_list);
        cons_free_list = cons_free_list->u.s.u.chain;
      }
    else
      {
        if (cons_block_index == CONS_BLOCK_SIZE)
  	{
  	  struct cons_block *new
  	    = lisp_align_malloc (sizeof *new, MEM_TYPE_CONS);
  	  memset (new->gcmarkbits, 0, sizeof new->gcmarkbits);
  	  ASAN_POISON_CONS_BLOCK (new);
  	  new->next = cons_block;
  	  cons_block = new;
  	  cons_block_index = 0;
  	}
        ASAN_UNPOISON_CONS (&cons_block->conses[cons_block_index]);
        XSETCONS (val, &cons_block->conses[cons_block_index]);
        cons_block_index++;
      }

    XSETCAR (val, car);
    XSETCDR (val, cdr);
    eassert (!XCONS_MARKED_P (XCONS (val)));
    consing_until_gc -= sizeof (struct Lisp_Cons);
    cons_cells_consed++;
    return val;
  }
#+end_src

ä»å®ç°æ¥çœ‹ï¼Œæˆ‘ä»¬åªéœ€è¦è®© =cons_block_index= æš‚æ—¶ä¸º =Qnil= ï¼Œç„¶åè€—å°½å½“å‰ CONS block ååˆ†é…ä¸€æ•´ä¸ª CONS block çš„å†…å®¹å°±å¯ä»¥äº†ï¼Œè¿™å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç æ¥å®ç°ï¼š

#+begin_src c
  DEFUN ("yy-cons-bulk", Fyy_cons_bulk, Syy_cons_bulk, 0, 0, 0,
         doc: /* Create a CONS_BLOCK_SIZE vector containing a whole cons_block's conses.
  	       Return Cons of the last cons_block's rest number of cons and the vector.  */)
    (void)
  {
    Lisp_Object val;
    Lisp_Object vec;
    EMACS_INT cnt = 0;

    struct Lisp_Cons *copy = cons_free_list;
    cons_free_list = NULL;
    val = Qnil;
    while (cons_block_index < CONS_BLOCK_SIZE)
      {
        val = Fcons (Qnil, val);
        cnt = cnt + 1;
      }
    vec = make_vector (CONS_BLOCK_SIZE, Qnil);
    for (EMACS_INT i = 0; i < CONS_BLOCK_SIZE; i++)
      {
        val = Fcons (Qt, Qt);
        ASET(vec, i, val);
      }
    cons_free_list = copy;
    return Fcons(make_fixnum(cnt), vec);
  }

  // add defsubr in alloc.c's syms_of_alloc:
  void syms_of_alloc(void)
  {
    ...;
    defsubr (&Syy_cons_bulk);
    ...;
  }
#+end_src

=yy-cons-bulk= ä¼šåˆ†é…ä¸€ä¸ª CONS block ä¸Šçš„æ‰€æœ‰ CONSï¼Œå¹¶æ”¾åœ¨ä¸€ä¸ª VECTOR é‡Œé¢ï¼ŒåŠ ä¸Šä¸Šä¸€ä¸ª CONS block ä¸­çš„ç©ºé—² cons ä¸ªæ•°è¿”å›ã€‚ç”±äºè¿™äº› CONS åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„ï¼Œå®ƒä»¬çš„ç›¸é‚»åœ°å€ä¹‹å·®ä¸º 16 å­—èŠ‚ï¼Œé…åˆä¸‹é¢çš„ä»£ç å¯ä»¥æ£€éªŒæ‰€æœ‰ CONS çš„è¿ç»­æ€§ï¼š

#+begin_src c
  DEFUN ("yy-ptr", Fyy_ptr, Syy_ptr, 1, 1, 0,
         doc: /* yy's ptr function, get pointer value >> 3 */)
    (Lisp_Object obj)
  {
    if (!CONSP (obj))
      return Qnil;
    return make_ufixnum(XLI(obj) >> 3);
  }
  // Remember to add defsubr (&Syy_ptr)
#+end_src

#+begin_src elisp
(defun yy-bulk-test ()
  (let* ((a (cdr (yy-cons-bulk)))
	 (len (length a))
	 (i 0))
    (should (= len 2030))
    (should (zerop (% (yy-ptr (aref a 0)) (expt 2 12))))
    (while (< (incf i) len)
      (should (= 2 (- (yy-ptr (aref a i))
		      (yy-ptr (aref a (1- i)))))))))
#+end_src

åœ¨è¿™ä¸ª VECTOR ä¸Šåˆ›å»º plist çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

[[./5.png]]

è‡³äº alistï¼Œå¦‚æœä½¿ç”¨ =(push (cons k v) ls)= çš„æ–¹å¼åœ¨å•ä¸ªç©ºçš„ CONS block ä¸­åˆ›å»ºï¼Œç»“æ„å¦‚ä¸‹ï¼ˆé”®å€¼å¯¹ CONS å’Œåˆ—è¡¨ä¸»ä½“ CONS æ˜¯ç›¸é‚»äº¤é”™çš„ï¼‰ï¼š

[[./6.png]]

é™¤äº†è¿™ä¸€ç§ alist å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æŠŠ kv CONS æ”¾åœ¨å‰ 1015 ä¸ªï¼ŒæŠŠåˆ—è¡¨ CONS æ”¾åœ¨å 1015 ä¸ªï¼ˆæˆ–è€…å€’è¿‡æ¥ï¼‰ï¼Œä¸‹é¢æ˜¯ç”¨æ¥ç”Ÿæˆå•ä¸ª CONS block å†…çš„ plist/alist çš„å‡½æ•°ï¼ˆ =*-alist1= å¯¹åº”äº¤é”™åˆ†é…ï¼Œ =*-alist2= å¯¹åº”å‰ kv ååˆ—è¡¨ï¼Œ =*-alist3= å¯¹åº”å‰åˆ—è¡¨å kvï¼‰ï¼š

:make-plist-alist-1-2-3:
#+begin_src elisp
  (defun make-test-plist ()
    (let ((pv (cdr (yy-cons-bulk))))
      (cl-assert (= (length pv) 2030))
      (cl-do ((i 0 (1+ i)))
  	((> i 2028))
        (setcar (aref pv i) (/ i 2))
        (setcdr (aref pv i) (aref pv (1+ i))))
      (setcar (aref pv 2029) 1014)
      (setcdr (aref pv 2029) nil)
      (let ((pl (aref pv 0))
  	  (i 0))
        (cl-mapl (lambda (x)
  		 (cl-assert (eq x (aref pv i)))
  		 (cl-incf i))
  	       pl)
        (dotimes (i 1015)
  	(cl-assert (eq (plist-get pl i) i)))
        pl)))

  (defun make-test-alist1 ()
    (let ((av (cdr (yy-cons-bulk))))
      (cl-assert (= (length av) 2030))
      (cl-do ((i 0 (+ i 2))
  	    (j 1 (+ j 2)))
  	((= i 2028))
        (setcar (aref av i) (/ i 2))
        (setcdr (aref av i) (/ i 2))
        (setcar (aref av j) (aref av i))
        (setcdr (aref av j) (aref av (+ j 2))))
      (setcar (aref av 2028) 1014)
      (setcdr (aref av 2028) 1014)
      (setcar (aref av 2029) (aref av 2028))
      (setcdr (aref av 2029) nil)
      (let* ((al (aref av 1))
  	   (k 0))
        (dotimes (i 1015)
  	(cl-assert (eq (alist-get i al) i)))
        (cl-mapl (lambda (x)
  		 (cl-assert (eq x (aref av (1+ (* 2 k)))))
  		 (cl-assert (eq (car x) (aref av (* k 2))))
  		 (cl-incf k))
  	       al)
        al)))

  (defun make-test-alist2 ()
    (let ((av (cdr (yy-cons-bulk))))
      (cl-assert (= (length av) 2030))
      (cl-do ((i 0 (+ i 1)))
  	((> i 1014))
        (setcar (aref av i) i)
        (setcdr (aref av i) i))
      (cl-do ((i 1015 (+ i 1)))
  	((> i 2028))
        (setcar (aref av i) (aref av (- i 1015)))
        (setcdr (aref av i) (aref av (1+ i))))
      (setcar (aref av 2029) (aref av 1014))
      (setcdr (aref av 2029) nil)
      (let* ((al (aref av 1015))
  	   (k 0))
        (dotimes (i 1015)
  	(cl-assert (eq (alist-get i al) i)))
        (cl-mapl (lambda (x)
  		 (cl-assert (eq x (aref av (+ k 1015))))
  		 (cl-assert (eq (car x) (aref av k)))
  		 (cl-incf k))
  	       al)
        al)))

  (defun make-test-alist3 ()
    (let ((av (cdr (yy-cons-bulk))))
      (cl-assert (= (length av) 2030))
      (cl-do ((i 1015 (+ i 1)))
  	((> i 2029))
        (setcar (aref av i) (- i 1015))
        (setcdr (aref av i) (- i 1015)))
      (cl-do ((i 0 (+ i 1)))
  	((> i 1014))
        (setcar (aref av i) (aref av (+ i 1015)))
        (setcdr (aref av i) (aref av (1+ i))))
      (setcar (aref av 1014) (aref av 2029))
      (setcdr (aref av 1014) nil)
      (let* ((al (aref av 0))
  	   (k 0))
        (dotimes (i 1015)
  	(cl-assert (eq (alist-get i al) i)))
        (cl-mapl (lambda (x)
  		 (cl-assert (eq x (aref av k)))
  		 (cl-assert (eq (car x) (aref av (+ k 1015))))
  		 (cl-incf k))
  	       al)
        al)))
#+end_src
:end:

ä¸‹é¢æ˜¯æµ‹è¯•ä»£ç å’Œæ–°çš„æµ‹è¯•ç»“æœï¼š

:test:
#+begin_src elisp
  (progn 
    (defun test-p (key plist rep)
      (declare (ftype (function (t list fixnum) float)))
      (let ((t1 (float-time)))
        (dotimes (_ rep)
  	(plist-get plist key))
        (* (/ (- (float-time) t1) rep) (expt 10 9))))

    (defun test-a (key alist rep)
      (declare (ftype (function (t list fixnum) float)))
      (let ((t1 (float-time)))
        (dotimes (_ rep)
  	(alist-get key alist))
        (* (/ (- (float-time) t1) rep) (expt 10 9))))
    (dlet ((native-comp-speed 3))
      (native-compile 'test-p)
      (native-compile 'test-a)))

  (setq pl (make-test-plist))
  (setq al1 (make-test-alist1))
  (setq al2 (make-test-alist2))
  (setq al3 (make-test-alist3))

  (when nil
    (setq a 
  	(let ((res))
  	  (dotimes (i 1015)
  	    (push (test-p i pl 10000) res))
  	  (reverse res)))
    (setq b
  	(let ((res))
  	  (dotimes (i 1015)
  	    (push (test-a i al1 10000) res))
  	  (reverse res)))
    (setq c
  	(let ((res))
  	  (dotimes (i 1015)
  	    (push (test-a i al2 10000) res))
  	  (reverse res)))
    (setq d
  	(let ((res))
  	  (dotimes (i 1015)
  	    (push (test-a i al3 10000) res))
  	  (reverse res)))
    )
#+end_src
:end:

[[./7.png]]

* æ¶ˆé™¤æ— å…³ä»£ç çš„å½±å“

å¦‚ä½ æ‰€è§ï¼Œå³ä½¿â€œæ¶ˆé™¤â€äº† cache missï¼Œ =plist-get= å’Œ =alist-get= çš„æ€§èƒ½å·®è·ä¾æ—§æ˜æ˜¾ã€‚ =plist-get= å’Œ =alist-get= ä¹Ÿä»æ—§å­˜åœ¨é™¤ç®—æ³•ä¹‹å¤–çš„å·®å¼‚ï¼š

- =plist-get= æ˜¯ subrï¼Œè€Œ =alist-get= æ˜¯æ™®é€šçš„ Elisp å‡½æ•°
- =plist-get= ä½¿ç”¨äº† =FOR_EACH_TAIL_SAFE= ï¼Œè€Œ =alist-get= ï¼ˆé—´æ¥ï¼‰ä½¿ç”¨ =FOR_EACH_TAIL=

ä¸ºäº†æ¶ˆé™¤ä¸€äº›å¯èƒ½çš„é¢å¤–è°ƒç”¨å’Œæ£€æŸ¥å¼€é”€ï¼Œæˆ‘é‡æ–°å®ç°äº† =my-plist-get= å’Œ =my-alist-get= ï¼š

#+begin_src c
  DEFUN ("my-plist-get", Fmy_plist_get, Smy_plist_get, 2, 2, 0,
         doc: /* plist_get, without any check. */)
    (Lisp_Object plist, Lisp_Object prop)
  {
    for(; !NILP (plist); plist = XCDR (XCDR (plist)))
      {
        if (EQ (XCAR (plist), prop))
          return XCAR (XCDR (plist));
      }
    return Qnil;
  }
  DEFUN ("my-alist-get", Fmy_alist_get, Smy_alist_get, 2, 2, 0,
         doc: /* alist_get, witout any check. */)
    (Lisp_Object key, Lisp_Object alist)
  {
    for (; ! NILP (alist); alist = XCDR (alist))
      if (EQ (XCAR (XCAR (alist)), key))
        return XCDR (XCAR (alist));
    return Qnil;
  }
#+end_src

ç„¶åä½¿ç”¨ä¸Šä¸€èŠ‚çš„æµ‹è¯•ä»£ç é‡æ–°è¿›è¡Œäº†æµ‹è¯•ï¼ˆæŠŠ =plist/alist-get= æ›¿æ¢ä¸º =my-plist/alist-get= ï¼‰ï¼š

[[./8.png]]

å¯è§ï¼Œåœ¨å»æ‰äº†å‡ ä¹æ‰€æœ‰æ£€æŸ¥çš„æƒ…å†µä¸‹ï¼Œä¸¤è€…çš„æ‹Ÿåˆæ›²çº¿çš„æ–œç‡å‡ ä¹æ˜¯ 1:2 çš„å…³ç³»ã€‚

ä¸‹é¢æ˜¯ objdump çš„è¾“å‡ºç»“æœï¼š

:objdump:
#+begin_src asm
  00000000000015b0 <Fmy_plist_get>:
      15b0:	53                   	push   %rbx
      15b1:	49 89 d1             	mov    %rdx,%r9
      15b4:	48 85 c9             	test   %rcx,%rcx
      15b7:	0f 84 bb 00 00 00    	je     1678 <Fmy_plist_get+0xc8>
      15bd:	48 8b 05 00 00 00 00 	mov    0x0(%rip),%rax        # 15c4 <Fmy_plist_get+0x14>
      15c4:	44 0f b6 90 10 11 00 	movzbl 0x1110(%rax),%r10d
      15cb:	00 
      15cc:	eb 20                	jmp    15ee <Fmy_plist_get+0x3e>
      15ce:	66 90                	xchg   %ax,%ax
      15d0:	49 8b 50 08          	mov    0x8(%r8),%rdx
      15d4:	4c 8d 42 fd          	lea    -0x3(%rdx),%r8
      15d8:	48 39 c1             	cmp    %rax,%rcx
      15db:	0f 84 8b 00 00 00    	je     166c <Fmy_plist_get+0xbc>
      15e1:	49 8b 48 08          	mov    0x8(%r8),%rcx
      15e5:	48 85 c9             	test   %rcx,%rcx
      15e8:	0f 84 8a 00 00 00    	je     1678 <Fmy_plist_get+0xc8>
      15ee:	48 8b 51 fd          	mov    -0x3(%rcx),%rdx
      15f2:	4c 8d 41 fd          	lea    -0x3(%rcx),%r8
      15f6:	4c 89 c9             	mov    %r9,%rcx
      15f9:	48 89 d0             	mov    %rdx,%rax
      15fc:	45 84 d2             	test   %r10b,%r10b
      15ff:	74 cf                	je     15d0 <Fmy_plist_get+0x20>
      1601:	41 8d 41 fb          	lea    -0x5(%r9),%eax
      1605:	a8 07                	test   $0x7,%al
      1607:	75 1d                	jne    1626 <Fmy_plist_get+0x76>
      1609:	48 b8 00 00 00 3f 00 	movabs $0x400000003f000000,%rax
      1610:	00 00 40 
      1613:	49 23 41 fb          	and    -0x5(%r9),%rax
      1617:	49 bb 00 00 00 06 00 	movabs $0x4000000006000000,%r11
      161e:	00 00 40 
      1621:	4c 39 d8             	cmp    %r11,%rax
      1624:	74 5a                	je     1680 <Fmy_plist_get+0xd0>
      1626:	44 8d 5a fb          	lea    -0x5(%rdx),%r11d
      162a:	48 89 d0             	mov    %rdx,%rax
      162d:	41 83 e3 07          	and    $0x7,%r11d
      1631:	75 9d                	jne    15d0 <Fmy_plist_get+0x20>
      1633:	49 bb 00 00 00 3f 00 	movabs $0x400000003f000000,%r11
      163a:	00 00 40 
      163d:	4c 23 5a fb          	and    -0x5(%rdx),%r11
      1641:	4c 89 da             	mov    %r11,%rdx
      1644:	49 bb 00 00 00 06 00 	movabs $0x4000000006000000,%r11
      164b:	00 00 40 
      164e:	4c 39 da             	cmp    %r11,%rdx
      1651:	0f 85 79 ff ff ff    	jne    15d0 <Fmy_plist_get+0x20>
      1657:	49 8b 50 08          	mov    0x8(%r8),%rdx
      165b:	48 8b 40 03          	mov    0x3(%rax),%rax
      165f:	4c 8d 42 fd          	lea    -0x3(%rdx),%r8
      1663:	48 39 c1             	cmp    %rax,%rcx
      1666:	0f 85 75 ff ff ff    	jne    15e1 <Fmy_plist_get+0x31>
      166c:	48 8b 42 fd          	mov    -0x3(%rdx),%rax
      1670:	5b                   	pop    %rbx
      1671:	c3                   	ret
      1672:	66 0f 1f 44 00 00    	nopw   0x0(%rax,%rax,1)
      1678:	31 c0                	xor    %eax,%eax
      167a:	5b                   	pop    %rbx
      167b:	c3                   	ret
      167c:	0f 1f 40 00          	nopl   0x0(%rax)
      1680:	44 8d 5a fb          	lea    -0x5(%rdx),%r11d
      1684:	49 8b 49 03          	mov    0x3(%r9),%rcx
      1688:	48 89 d0             	mov    %rdx,%rax
      168b:	41 83 e3 07          	and    $0x7,%r11d
      168f:	0f 85 3b ff ff ff    	jne    15d0 <Fmy_plist_get+0x20>
      1695:	eb 9c                	jmp    1633 <Fmy_plist_get+0x83>
      1697:	66 0f 1f 84 00 00 00 	nopw   0x0(%rax,%rax,1)
      169e:	00 00 

  00000000000012f0 <Fmy_alist_get>:
      12f0:	56                   	push   %rsi
      12f1:	53                   	push   %rbx
      12f2:	49 89 c9             	mov    %rcx,%r9
      12f5:	48 85 d2             	test   %rdx,%rdx
      12f8:	0f 84 b2 00 00 00    	je     13b0 <Fmy_alist_get+0xc0>
      12fe:	48 8b 05 00 00 00 00 	mov    0x0(%rip),%rax        # 1305 <Fmy_alist_get+0x15>
      1305:	44 0f b6 90 10 11 00 	movzbl 0x1110(%rax),%r10d
      130c:	00 
      130d:	eb 17                	jmp    1326 <Fmy_alist_get+0x36>
      130f:	90                   	nop
      1310:	48 39 c1             	cmp    %rax,%rcx
      1313:	0f 84 89 00 00 00    	je     13a2 <Fmy_alist_get+0xb2>
      1319:	49 8b 50 08          	mov    0x8(%r8),%rdx
      131d:	48 85 d2             	test   %rdx,%rdx
      1320:	0f 84 8a 00 00 00    	je     13b0 <Fmy_alist_get+0xc0>
      1326:	48 8b 42 fd          	mov    -0x3(%rdx),%rax
      132a:	4c 8d 42 fd          	lea    -0x3(%rdx),%r8
      132e:	4c 89 c9             	mov    %r9,%rcx
      1331:	48 8b 50 fd          	mov    -0x3(%rax),%rdx
      1335:	4c 8d 58 fd          	lea    -0x3(%rax),%r11
      1339:	48 89 d0             	mov    %rdx,%rax
      133c:	45 84 d2             	test   %r10b,%r10b
      133f:	74 cf                	je     1310 <Fmy_alist_get+0x20>
      1341:	41 8d 41 fb          	lea    -0x5(%r9),%eax
      1345:	a8 07                	test   $0x7,%al
      1347:	75 1d                	jne    1366 <Fmy_alist_get+0x76>
      1349:	48 b8 00 00 00 3f 00 	movabs $0x400000003f000000,%rax
      1350:	00 00 40 
      1353:	49 23 41 fb          	and    -0x5(%r9),%rax
      1357:	48 bb 00 00 00 06 00 	movabs $0x4000000006000000,%rbx
      135e:	00 00 40 
      1361:	48 39 d8             	cmp    %rbx,%rax
      1364:	74 52                	je     13b8 <Fmy_alist_get+0xc8>
      1366:	8d 5a fb             	lea    -0x5(%rdx),%ebx
      1369:	48 89 d0             	mov    %rdx,%rax
      136c:	83 e3 07             	and    $0x7,%ebx
      136f:	75 9f                	jne    1310 <Fmy_alist_get+0x20>
      1371:	48 bb 00 00 00 3f 00 	movabs $0x400000003f000000,%rbx
      1378:	00 00 40 
      137b:	48 23 5a fb          	and    -0x5(%rdx),%rbx
      137f:	48 89 da             	mov    %rbx,%rdx
      1382:	48 bb 00 00 00 06 00 	movabs $0x4000000006000000,%rbx
      1389:	00 00 40 
      138c:	48 39 da             	cmp    %rbx,%rdx
      138f:	0f 85 7b ff ff ff    	jne    1310 <Fmy_alist_get+0x20>
      1395:	48 8b 40 03          	mov    0x3(%rax),%rax
      1399:	48 39 c1             	cmp    %rax,%rcx
      139c:	0f 85 77 ff ff ff    	jne    1319 <Fmy_alist_get+0x29>
      13a2:	49 8b 43 08          	mov    0x8(%r11),%rax
      13a6:	5b                   	pop    %rbx
      13a7:	5e                   	pop    %rsi
      13a8:	c3                   	ret
      13a9:	0f 1f 80 00 00 00 00 	nopl   0x0(%rax)
      13b0:	31 c0                	xor    %eax,%eax
      13b2:	5b                   	pop    %rbx
      13b3:	5e                   	pop    %rsi
      13b4:	c3                   	ret
      13b5:	0f 1f 00             	nopl   (%rax)
      13b8:	8d 5a fb             	lea    -0x5(%rdx),%ebx
      13bb:	49 8b 49 03          	mov    0x3(%r9),%rcx
      13bf:	48 89 d0             	mov    %rdx,%rax
      13c2:	83 e3 07             	and    $0x7,%ebx
      13c5:	0f 85 45 ff ff ff    	jne    1310 <Fmy_alist_get+0x20>
      13cb:	eb a4                	jmp    1371 <Fmy_alist_get+0x81>
      13cd:	0f 1f 00             	nopl   (%rax)
#+end_src
:end:

æˆ‘æ‰‹åŠ¨åæ±‡ç¼–äº†ä¸€ä¸‹ï¼Œå»æ‰äº† =EQ= æ¯”è¾ƒçš„ =SYMBOL_WITH_POS_P= ç›¸å…³éƒ¨åˆ†ï¼š

#+begin_src c
  Fmy_alist_get (rdx /* alist */, rcx /* key */)
  {
    if (rdx == Qnil)             // 12f5: test   %rdx,%rdx
      {                          // 12f8: je     13b0 <Fmy_alist_get+0xc0>
        eax = 0;                 // 13b0: xor    %eax,%eax
        return;                  // 13b4: ret
      }
    for (;;)
      {
        rax = mov_xcar(rdx);     // 1326: mov    -0x3(%rdx),%rax
        r8  = lea_xcons(rdx);    // 132a: lea    -0x3(%rdx),%r8
        rcx = r9;                // 132e: mov    %r9,%rcx
        rdx = mov_xcar(rax);     // 1331: mov    -0x3(%rax),%rdx
        r11 = lea_xcons(rax);    // 1335: lea    -0x3(%rax),%r11
        rax = rdx;               // 1339: mov    %rdx,%rax
        if (rax == rcx)          // 1310: cmp    %rax,%rcx
  	{                      // 1313: je     13a2 <Fmy_alist_get+0xb2>
  	  rax = mov_cdr(r11);  // 13a2: mov    0x8(%r11),%rax
  	  return;              // 13a8: ret
  	}
        rdx = mov_cdr(r8);       // 1319: mov    0x8(%r8),%rdx
        if (rdx == Qnil)         // 131d: test   %rdx,%rdx
  	{                      // 1320: je     13b0 <Fmy_alist_get+0xc0>
  	  eax = 0;             // 13b0: xor    %eax, %eax
  	  return;              // 13b4: ret
  	}
      }
  }
#+end_src

#+begin_src c
  Fmy_plist_get(rdx /* key */, rcx /* plist */)
  {
    r9 = rdx;                    // 15b1: mov    %rdx,%r9
    if (rcx == Qnil)             // 15b5: test   %rcx,%rcx
      {                          // 15b7: je     1678 <Fmy_plist_get+0xc8>
        eax = 0;                 // 1678: xor    %eax,%eax
        return;                  // 167b: ret
      }
    for(;;)
      {
        rdx = mov_xcar(rcx);     // 15ee: mov    -0x3(%rcx),%rdx
        r8  = lea_xcons(rcx);    // 15f2: lea    -0x3(%rcx),%r8
        rcx = r9;                // 15f6: mov    %r9,%rcx
        rax = rdx;               // 15f9: mov    %rdx,%rax
        rdx = mov_cdr(r8);       // 15d0: mov    0x8(%r8),%rdx
        r8  = lea_xcons(rdx);    // 15d4: lea    -0x3(%rdx),%r8
        if (rcx == rax)          // 15d8: cmp    %rax,%rcx
          {                      // 15db: je     166c <Fmy_plist_get+0xbc>
            rax = mov_xcar(rdx); // 166c: mov    -0x3(%rdx),%rax
            return;              // 1671: ret
          }
        rcx = mov_cdr(r8);       // 15e1: mov    0x8(%r8),%rcx
        if (rcx == Qnil)         // 15e5: test   %rcx,%rcx
          {                      // 15e8: je     1678 <Fmy_plist_get+0xc8>
            eax = 0;             // 1678: xor    %eax,%eax
            return;              // 167b: ret
          }
      }
  }
#+end_src

=my-alist-get= æ¯æ¬¡å¾ªç¯éœ€è¦ä¸€æ¬¡ CDR æ“ä½œï¼Œè€Œ =my-plist-get= éœ€è¦ä¸¤æ¬¡ï¼Œè¿™ä¸ä¸Šé¢çš„æ–œç‡ 1:2 æ˜¯å»åˆçš„ï¼Œä½†æ˜¯å…·ä½“è¦å¦‚ä½•è§£é‡Šå‘¢ï¼Ÿ

* VTune æµ‹è¯•

åŸæœ¬æˆ‘æ‰“ç®—åœ¨ WSL ä¸­ä½¿ç”¨ perf æµ‹è¯•ï¼Œä½†æ˜¯å…­æœˆå…­å·ç©ºè°ƒç½•è§åœ°æ¼æ°´æŠŠæˆ‘ç¬”è®°æœ¬ç»™çƒ§äº†ï¼Œç©ºè°ƒå¸ˆå‚…æ¥æ£€æŸ¥çš„æ—¶å€™å‘ç°æ˜¯å› ä¸ºæ’æ°´ç®¡é“å¤ªé•¿åŠ ä¸Šæ—¶é—´æœ‰ç‚¹ä¹…äº†å¼¯æˆäº† U å‹ï¼Œæ°´ç´¯ç§¯åœ¨ä¸­é—´æ’ä¸å‡ºå»åªèƒ½ä»ç©ºè°ƒå†…æœºæ’å‡ºæ¥ï¼Œæ­£å¥½æ»´åˆ°å†…æœºæ­£ä¸‹æ–¹çš„ç”µè„‘ä¸Šã€‚æˆ‘ä¹Ÿåªèƒ½å¿ç—›æŠŠ Remibook 2021 æ¢æˆäº†æœ€æ–°çš„ Redmibook 2025 pro 16ï¼Œç®—ä¸Šå›½è¡¥ 6000 å¤§æ´‹ï¼ŒEmacs çš„å¯åŠ¨æ—¶é—´ä¹Ÿä» 3 ç§’æå‡ 100% æ¥åˆ° 1.5 ç§’ã€‚

é—²è¯è¯´å¾—æœ‰ç‚¹å¤šäº†ï¼Œç”±äºæ‡’å¾—é‡è£… WSL äº†ï¼Œæˆ‘ç›´æ¥ä¸‹è½½äº† Windows ä¸Šå¯ç”¨çš„ Intel æ€§èƒ½è°ƒä¼˜å·¥å…· [[https://www.intel.com/content/www/us/en/developer/tools/oneapi/vtune-profiler.html#gs.me11z4][VTune]]ã€‚å®ƒæä¾›äº†å¾ˆå¤šæµ‹è¯•æ–¹å¼ï¼Œä¸è¿‡æˆ‘ç”¨å¾—ä¸Šçš„åªæœ‰ Hotspots å’Œ Microarchitecture Explorationã€‚ä½¿ç”¨ä¹‹å‰è®°å¾—å‚è€ƒ[[https://www.intel.com/content/www/us/en/docs/vtune-profiler/user-guide/2023-1/install-sampling-drivers-for-windows-targets.html][æ–‡æ¡£]]å®‰è£… sampling driverï¼Œç„¶åä»¥ç®¡ç†å‘˜èº«ä»½å¯åŠ¨ VTuneã€‚

ä¸‹å›¾æ˜¯ alist çš„ Hotspts æµ‹è¯•ï¼Œæµ‹è¯•ä»£ç ä¸å˜ï¼Œåªæ˜¯æŠŠå¾ªç¯æ¬¡æ•°ä» 10000 æ”¹ä¸ºäº† 20000ï¼š

[[./9.jpeg]]

æœ€å‰é¢çš„ä¸¤æ¡ XCONS å¯¹åº”äºæ±‡ç¼–ä¸­çš„ä¸¤æ¡ LEA æŒ‡ä»¤ï¼Œå‰ä¸€æ¡ 2.167sï¼Œåä¸€æ¡ 8.981sï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯ä¼˜åŒ–åŸå› æ—¶é—´å…¨ç®—åœ¨ LEA ä¸Šäº†ã€‚

#+begin_src asm
  1320:	0f 84 8a 00 00 00    	je     13b0 <Fmy_alist_get+0xc0>
  1326:	48 8b 42 fd          	mov    -0x3(%rdx),%rax
  132a:	4c 8d 42 fd          	lea    -0x3(%rdx),%r8  ;; 2.167s
  132e:	4c 89 c9             	mov    %r9,%rcx
  1331:	48 8b 50 fd          	mov    -0x3(%rax),%rdx
  1335:	4c 8d 58 fd          	lea    -0x3(%rax),%r11 ;; 8.981s
#+end_src

plist çš„æµ‹è¯•å’Œ alist çš„å”¯ä¸€åŒºåˆ«æ˜¯å¤šå‡ºçš„ =Fmy_plist_get= æ—¶é—´ï¼Œå·®ä¸å¤šæ­£å¥½æ˜¯ä¸¤æ¡ XCONS ç”¨æ—¶ä¹‹å’Œï¼Œæˆ‘ä¹Ÿä¸å¤ªæ‡‚ä¸ºä»€ä¹ˆæŠŠæ—¶é—´ç»Ÿè®¡åˆ°å®ƒä¸Šé¢äº†...

[[./10.png]]

ä¸‹å›¾åˆ†åˆ«æ˜¯å¯¹ plist å’Œ alist çš„ Microarchitecture æµ‹è¯•ï¼Œä»¥åŠ VTune å¯¹å„é¡¹æŒ‡æ ‡çš„è§£é‡Šè¯´æ˜ï¼Œæˆ‘åªæ‘˜å–äº†æ ‡çº¢çš„æŒ‡æ ‡è¯´æ˜ï¼š

| [[./11.png]] | [[./12.png]] |

- MUX Reliability ::
  This metric estimates reliability of HW event-related metrics. Since the number of collected HW events exceeds the number of counters, VTune Profiler uses event multiplexing (MUX) to share HW counters and collect different subsets of events over time. This may affect the precision of collected event data. The ideal value for this metric is 1. If the value is less than 0.7, the collected data may be not reliable.
- Memory Bound ::
  This metric shows how memory subsystem issues affect the performance. Memory Bound measures a fraction of slots where pipeline could be stalled due to demand load or store instructions. This accounts mainly for incomplete in-flight memory demand loads that coincide with execution starvation in addition to less common cases where stores could imply back-pressure on the pipeline.
- L1 Bound ::
  This metric estimates how often the CPU was stalled without loads missing the L1 Data (L1D) cache. The L1D cache typically has the shortest latency. However, in certain cases like loads blocked on older stores, a load might suffer due to high latency even though it is being satisfied by the L1D. Another example is loads who miss in the TLB. These cases are characterized by execution unit stalls, while some non-completed demand load live in the machine without having that demand load missing the L1 cache.
- Core Bound ::
  This metric represents how much Core non-memory issues were of a bottleneck. Shortage in hardware compute resources, or dependencies software's instructions are both categorized under Core Bound. Hence it may indicate the machine ran out of an OOO resources, certain execution units are overloaded or dependencies in program's data- or instruction- flow are limiting the performance (e.g. FP-chained long-latency arithmetic operations).
- Cycles of 1 Port Utilized ::
  This metric represents cycles fraction where the CPU executed total of 1 uop per cycle on all execution ports (Logical Processor cycles since ICL, Physical Core cycles otherwise). This can be due to heavy data-dependency among software instructions, or oversubscribing a particular hardware resource. In some other cases with high 1_Port_Utilized and L1 Bound, this metric can point to L1 data-cache latency bottleneck that may not necessarily manifest with complete execution starvation (due to the short L1 latency e.g. walking a linked list) - looking at the assembly can be helpful.

ä»æµ‹è¯•ç»“æœæ¥çœ‹ï¼ŒL1 Bound å’Œ Cycles of 1 Port Utilized æ˜¯æœ€å¤§çš„å½±å“å› ç´ ï¼Œæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿˜æœ‰ä¸åˆ°åƒåˆ†ä¹‹ä¸€çš„æŒ‡ä»¤è·‘åˆ°å°æ ¸ä¸Šå»äº†ï¼Œç›´æ¥å¿½ç•¥ã€‚ä¸‹å›¾æ˜¯ä¸€äº›å…³é”®æŒ‡æ ‡çš„å¯¹æ¯”è¡¨æ ¼ï¼Œä»¥åŠæ‰€æœ‰æµ‹è¯•æ•°æ®è¡¨æ ¼ï¼š

#+attr_html: :class data
| NAME  |   CPI | Memory Bound | L1 Bound | Core Bound | Port Utilization |    0 | 1       |     2 |    3+ |
|-------+-------+--------------+----------+------------+------------------+------+---------+-------+-------|
| plist | 0.772 |        38.6% | *47.0%*  |      51.3% |            38.0% | 0.3% | *35.5%* |  7.1% | 10.0% |
| alist | 0.385 |        11.2% | 17.8%    |      58.8% |            43.3% | 0.2% | *33.2%* | 18.0% | 27.0% |

#+attr_html: :class data
| SUMMARY                             |           ALIST |           PLIST |
| Elapsed Time                        |         12.330s |         22.931s |
| Clockticks                          |  52,212,190,000 | 104,734,004,000 |
| Performance-core (P-core)           |  52,212,190,000 | 104,734,004,000 |
| Efficient-core (E-core)             |   1,157,404,000 |      58,976,000 |
| Low-power Efficient-core (LPE-core) |               0 |               0 |
| Instructions Retired                | 135,736,950,000 | 135,604,254,000 |
| Performance-core (P-core)           | 132,968,764,000 | 135,519,476,000 |
| Efficient-core (E-core)             |   2,768,186,000 |      84,778,000 |
| Low-power Efficient-core (LPE-core) |               0 |               0 |
| CPI Rate                            |           0.385 |           0.772 |
| MUX Reliability                     |           0.987 |           0.969 |
| Performance-core (P-core)           |                 |                 |
| Retiring                            |           24.3% |           12.9% |
| Front-End Bound                     |            0.8% |            0.7% |
| Bad Speculation                     |            4.9% |            0.0% |
| Back-End Bound                      |           70.0% |           89.9% |
| Memory Bound                        |           11.2% |           38.6% |
| L1 Bound                            |           17.8% |           47.0% |
| L2 Bound                            |            0.1% |            0.0% |
| L3 Bound                            |            0.1% |            0.1% |
| DRAM Bound                          |            0.1% |            0.0% |
| Store Bound                         |            0.0% |            0.0% |
| Core Bound                          |           58.8% |           51.3% |
| Divider                             |            0.0% |            0.0% |
| Serializing Operations              |            0.4% |            0.3% |
| Port Utilization                    |           43.3% |           38.0% |
| Cycles of 0 Ports Utilized          |            0.2% |            0.3% |
| Cycles of 1 Port Utilized           |           33.2% |           35.5% |
| Cycles of 2 Ports Utilized          |           18.0% |            7.1% |
| Cycles of 3+ Ports Utilized         |           27.0% |           10.0% |
| Efficient-core (E-core)             |                 |                 |
| Retiring                            |           25.5% |           23.7% |
| Front-End Bound                     |            2.8% |           17.8% |
| Bad Speculation                     |            2.3% |            7.4% |
| Back-End Bound                      |           64.0% |          100.0% |
| Core Bound                          |            0.7% |            1.5% |
| Resource Bound                      |           63.4% |          100.0% |
| Memory Scheduler                    |            0.3% |            0.0% |
| Non-memory Scheduler                |           73.1% |            4.5% |
| Register                            |            0.0% |            0.0% |
| Full Re-order Buffer (ROB)          |            0.0% |            0.0% |
| Serializing Operations              |            0.9% |            7.4% |
| Info Metrics                        |                 |                 |
| Store Bound                         |            0.0% |            0.0% |
| Load Bound                          |            3.6% |           11.9% |
| L1 Bound                            |            1.2% |            0.0% |
| L2 Bound                            |           50.0% |          100.0% |
| L2 Miss                             |           75.0% |            0.0% |
| L3 Bound                            |            0.0% |          100.0% |
| L3 Miss                             |           75.0% |            0.0% |
| Low-power Efficient-core (LPE-core) |                 |                 |
| Retiring                            |            0.0% |            0.0% |
| Front-End Bound                     |            0.0% |            0.0% |
| Bad Speculation                     |            0.0% |            0.0% |
| Back-End Bound                      |            0.0% |            0.0% |
| Info Metrics                        |                 |                 |
| Average CPU Frequency               |         4.7 GHz |         4.8 GHz |
| Total Thread Count                  |               3 |               3 |
| Paused Time                         |              0s |              0s |

* OOE ä¸ L1 cache latency

ä¸Šä¸€èŠ‚ä¸­çš„ VTune æŒ‡æ ‡è¯´æ˜ä¸­ï¼ŒCycles of 1 Port Utilized æœ‰å‡ å¥è¯ä¹Ÿè®¸å€¼å¾—é‡å¤ä¸€ä¸‹ï¼š

- Cycles of 1 Port Utilized :: \\
  This can be due to *heavy data-dependency* among software instructions, or oversubscribing a particular hardware resource.

  ...

  In some other cases with *high 1_Port_Utilized and L1 Bound*, this metric can point to *L1 data-cache latency bottleneck* that may not necessarily manifest with complete execution starvation *(due to the short L1 latency e.g. walking a linked list)* - looking at the assembly can be helpful.
  
å½“ *L1 Bound* å’Œ *Cycles of 1 Port Utilized* æŒ‡æ ‡éƒ½æ¯”è¾ƒé«˜æ—¶ï¼Œè¿™è¡¨æ˜å¯èƒ½å­˜åœ¨ä¸€ä¸ª L1 æ•°æ®ç¼“å­˜å»¶è¿Ÿç“¶é¢ˆï¼Œè¿™æ„å‘³ç€å³ä½¿æ•°æ®åœ¨æœ€å¿«çš„ L1 ç¼“å­˜ä¸­ï¼Œè®¿é—®å®ƒä»ç„¶éœ€è¦ä¸€äº›æ—¶é—´ã€‚ä»¥éå†é“¾è¡¨ä¸ºä¾‹ï¼Œç”±äº L1 å»¶è¿Ÿå¾ˆçŸ­ï¼Œè¿™ä¸€å»¶æ—¶ä¸ä¸€å®šä¼šè¡¨ç°ä¸ºå®Œå…¨çš„æ‰§è¡Œå•å…ƒåœé¡¿ï¼ˆcomplete execution starvationï¼‰ã€‚

è¿™ä¸€æè¿°ä¸æˆ‘ä»¬ä¸Šé¢çš„ Hotspots æµ‹è¯•æ˜¯å»åˆçš„ï¼Œå› ä¸º LEA æ‰§è¡Œåªéœ€è¦ä¸€ä¸ªæŒ‡ä»¤å‘¨æœŸï¼Œè€Œ L1-cache hit ä¸€èˆ¬éœ€è¦ 5 ä¸ªå‘¨æœŸï¼Œç¼“å­˜è®¿é—®çš„æ—¶é—´è¢«â€œé”™è¯¯â€åœ°ç®—åœ¨äº† LEA ä¸Šã€‚è€ƒè™‘åˆ°ä¸Šé¢çš„æµ‹è¯•æ•°æ®ä¸­ CPU çš„å¹³å‡é¢‘ç‡æ˜¯ 4.7GHZï¼Œ =(5 * 1 / 4.7HZ * 1E9) = 1.06ns= ï¼Œå·®ä¸å¤šä¸ =my-plist-get= å’Œ =my-alist-get= çš„é”®å€¼å¯¹ä½ç½®åºå·/è®¿é—®æ—¶é—´çš„æ›²çº¿æ–œç‡å»åˆã€‚

@cireu åœ¨ 15 æ¥¼æå‡º pointer chasing åï¼Œ@shynur åœ¨ [[https://emacs-china.org/t/plist-alist/29589/18][18 æ¥¼]]å†™é“ï¼š

#+begin_quote
> =(:a 1 :b 2 :c 3) => (:a . (1 . (:b . (2 . (:c . (3 . nil))))))= \\
> =((a . 1) (b . 2) (c . 3)) => ((a . 1) . ((b . 2) . ((c . 3) . nil)))=

è®¿é—® =plist[:b]=: ç¬¬ä¸€æ¬¡ car å‘ç°æ˜¯ =:a= , å† cdr ä¸¤æ¬¡åˆ° =:b=, car ä¸€ä¸‹å‘ç°æ˜¯è¦æ‰¾çš„é”®å€¼å¯¹, å† cdr + car æ‹¿åˆ°å€¼. æ€»å…± ä¸‰æ¬¡ car + ä¸‰æ¬¡ cdr

è®¿é—® =alist[:b]=: car ä¸¤æ¬¡å‘ç°æ˜¯ =:a=, å† cdr + car æ‹¿åˆ°ä¸‹ä¸€ä¸ªé”®å€¼å¯¹, å† car å‘ç° key æ˜¯ =:b= , å† cdr æ‹¿åˆ°å€¼. æ€»å…± å››æ¬¡ car + ä¸¤æ¬¡ cdr

ç†è®ºä¸Šçš„ç®—æ³•å¤æ‚åº¦æ ¹æœ¬æ²¡æœ‰ä»»ä½•åŒºåˆ«
#+end_quote

*å¦‚æœä»£ç æ˜¯é¡ºåºæ‰§è¡Œçš„è¯* ï¼Œplist/alist çš„æŸ¥æ‰¾ç†è®ºä¸Šçš„ç®—æ³•å¤æ‚åº¦æ ¹æœ¬æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚ä½†æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ° =my-plist-get= å’Œ =my-alist-get= ä¸­ *éå†* å’Œ *é”®å€¼åˆ¤æ–­* æ˜¯ *å¯ä»¥å¹¶è¡Œ* çš„ã€‚å®é™…çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äº CPU çš„ OOEï¼ˆä¹±åºæ‰§è¡Œï¼ŒOut-of-Order Executionï¼‰ï¼Œalist ä¸­é”®å€¼åˆ¤æ–­çš„ =(eq (car (car alist)) key)= ä¸éå†æ“ä½œ =(cdr alist)= å¯ä»¥å¹¶è¡Œï¼›plist ä¸­çš„ =(eq (car plist))= ä¸éå†æ“ä½œ =(cdr (cdr plist))= å¯ä»¥å¹¶è¡Œï¼Œå› æ­¤å®é™…çš„æŸ¥æ‰¾ç”¨æ—¶å–å†³äºæŸ¥æ‰¾é¡¹çš„ä½ç½®ï¼ˆåˆ—è¡¨éå†ç”¨æ—¶ï¼‰ä¸æœ€åä¸€æ¬¡é”®æ¯”è¾ƒå’Œå–å€¼ç”¨æ—¶ã€‚

ä½œä¸ºè¡¥å……è¯´æ˜ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹ä½¿ç”¨ =pesudo-pget= å’Œ =pesudo-aget= æ—¶çš„é”®å€¼å¯¹åºå·/æ—¶é—´æ›²çº¿ï¼Œæµ‹è¯•ä»£ç ä¾æ—§ä¸å˜ï¼Œå°† =my-a/plist-get= æ”¹ä¸º =pesudo-a/pget= å³å¯ï¼š

#+caption: è§£é‡Šå‡½æ•°(i)/å­—èŠ‚ç¼–è¯‘(b)/native-comp(n -O3)
[[./13.png]]

è§£é‡Šå‡½æ•°çš„æ›²çº¿ä¸ CAR/CDR å¼€é”€å‡ ä¹ç›¸ç­‰è¿™ä¸€äº‹å®éå¸¸å»åˆï¼ˆ2CAR + 1CDR = 2CDR + 1CARï¼‰ï¼Œnative-comp ç¼–è¯‘åçš„ä»£ç ä¹Ÿä¸ =my-a/plist-get= æ›²çº¿ï¼ˆæ›´å‡†ç¡®åœ°è¯´æ˜¯ =plist-get= å’Œ =alist-get= æ›²çº¿ï¼‰éå¸¸æ¥è¿‘ã€‚æ¯”è¾ƒè®©æˆ‘æƒŠè®¶çš„æ˜¯ä»å­—èŠ‚ç¼–è¯‘å¼€å§‹ =pesudo-aget= å°±æ¯” =pesudo-pget= å¿«äº†ï¼Œä¸‹é¢æ˜¯å®ƒä»¬çš„å­—èŠ‚ç¼–è¯‘ç ï¼š

:byte-comp-code:
#+begin_src text
byte code for pesudo-aget:
  doc:   ...
  args: (arg1 arg2)
0:1	dup	  
1	goto-if-nil 2
4	dup	  
5	car	  
6	car	  
7	stack-ref 2
8	eq	  
9	goto-if-not-nil 2
12	cdr	  
13	goto	  1
16:2	dup	  
17	goto-if-nil-else-pop 3
20	dup	  
21	car	  
22	cdr	  
23:3	return	  
#+end_src

#+begin_src text
byte code for pesudo-pget:
  doc:   ...
  args: (arg1 arg2)
0:1	stack-ref 1
1	goto-if-nil 2
4	stack-ref 1
5	car	  
6	stack-ref 1
7	eq	  
8	goto-if-not-nil 2
11	stack-ref 1
12	cdr	  
13	cdr	  
14	stack-set 2
16	goto	  1
19:2	stack-ref 1
20	goto-if-nil-else-pop 3
23	stack-ref 1
24	cdr	  
25	car	  
26:3	return	  
#+end_src
:end:

* ç»“è®ºä¸åè®°

- çœæµç‰ˆ :: pointer chasingï¼Œè¶Šé•¿è¶Šæ…¢ã€‚

- å®Œæ•´ç‰ˆ :: é€ æˆ eq æ¯”è¾ƒ alist/plist æ€§èƒ½å·®è·çš„åŸå› æ˜¯åœ¨åˆ—è¡¨éå†è¿‡ç¨‹ä¸­ plist æ¯æ¬¡éœ€è¦ä¸¤æ¬¡ CDR è€Œ alist åªéœ€è¦ä¸€æ¬¡ï¼Œç”±äºé”®å€¼æ¯”è¾ƒæ“ä½œä¸åˆ—è¡¨éå†æ“ä½œå¯å¹¶è¡Œä¸”é”®å€¼æ¯”è¾ƒæ“ä½œç”¨æ—¶è¿œå°äºå†…å­˜è¯»å–å¼€é”€ï¼ˆç”šè‡³æ˜¯ L1-cache hit å¼€é”€ï¼‰ä¸”é“¾è¡¨éå†æ“ä½œéš¾ä»¥å¹¶è¡Œï¼ŒæŸ¥æ‰¾çš„ä¸»è¦æ—¶é—´å¼€é”€æ¥æºæ˜¯åœ¨ä»è¡¨å¤´åˆ°é”®å€¼å¯¹æ‰€åœ¨ä½ç½®çš„éå†è¿‡ç¨‹ã€‚

è™½ç„¶åœ¨ä¸€å¼€å§‹æˆ‘å°±è®¤ä¸º plist å’Œ alist æŸ¥æ‰¾æ€§èƒ½å·®è·çš„ä¸»è¦åŸå› æ˜¯ plist æ›´é•¿ï¼Œä½†æ˜¯è¦æ¯”è¾ƒä¸¥è°¨åœ°è¯´æ˜è¿™ä¸€ç‚¹å¹¶ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚é€šè¿‡è¿™ä¸€æ¬¡æŠ˜è…¾æˆ‘ä¹Ÿæ˜¯å­¦ä¼šäº†æ€ä¹ˆç”¨æ€§èƒ½æµ‹è¯•å·¥å…·å’Œè¯»ç®€å•çš„æ±‡ç¼–ã€‚

æ„Ÿè°¢å‚ä¸è®¨è®ºçš„å„ä½å›å‹ã€‚

# [[https://www.pixiv.net/artworks/98804219][file:dev/p1.jpg]]

# | [[https://www.pixiv.net/artworks/130408619][file:dev/p2.jpg]] | [[https://www.pixiv.net/artworks/131194579][file:dev/p3.jpg]] | [[https://www.pixiv.net/artworks/131593145][file:dev/p4.jpg]] |
